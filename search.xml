<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>nginx反向代理dns缓存问题</title>
    <url>/2023/05/22/nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86dns%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<h1 id="问题简介"><a href="#问题简介" class="headerlink" title="问题简介"></a>问题简介</h1><p>example.com为cdn域名，ip是动态解析的，上线几天后，发现网站资源加载不出来，查看nginx日志发现资源全部超时了。查询nginx相关文档，确认nginx在启动加载配置文件时，会把域名接信息成ip，然后把IP缓存起来，以后会一直使用解析到的IP并且不会再更改，除非重新启动Nginx，Nginx才会重新解析域名。<span id="more"></span></p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><h2 id="第一种-使用nginx的resolver"><a href="#第一种-使用nginx的resolver" class="headerlink" title="第一种 使用nginx的resolver"></a>第一种 使用nginx的resolver</h2><ul>
<li><p>默认nginx会使用&#x2F;etc&#x2F;resolv.conf下的域名服务器进行解析</p>
</li>
<li><p>可以通过在nginx配置文件中的http部分或者server部分设定如下配置</p>
<blockquote>
<p>server {</p>
<p> resolver 100.100.2.136 100.100.2.138 valid&#x3D;3000s;</p>
<p> resolver_timeout 3s;</p>
<p>}</p>
</blockquote>
</li>
<li><p>resolver 后面指定DNS服务器，可以指定多个，空格隔开</p>
</li>
<li><p>valid设置DNS缓存失效时间</p>
</li>
<li><p>resolver_timeout 指定解析域名时，DNS服务器的超时时间，建议3秒左右</p>
</li>
</ul>
<blockquote>
<p> 当resolver 后面跟多个DNS服务器时，一定要保证这些DNS服务器都是有效的，因为这种是负载均衡模式的，当DNS记录失效了(超过valid时间)，首先由第一个DNS服务器去解析，下一次继续失效时由第二个DNS服务器去解析，如有任何一个DNS服务器故障，那么这一次的解析会一直持续到resolver_timeout，然后解析失败，且日志报错解析不了域名，通过页面抛出502错误。</p>
</blockquote>
<h2 id="第二种-使用tengine"><a href="#第二种-使用tengine" class="headerlink" title="第二种 使用tengine"></a>第二种 使用tengine</h2><p>  版本2.1.2以上，Tengine的ngx_http_upstream_dynamic_module模块，提供了在运行时动态解析upstream中server域名的功能。</p>
<blockquote>
<p>upstream backend {<br>dynamic_resolve fallback&#x3D;stale fail_timeout&#x3D;30s;<br>server a.com;<br>server b.com;<br>}</p>
</blockquote>
]]></content>
      <categories>
        <category>nginx</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s部署nacos集群</title>
    <url>/2023/05/22/k8s%E9%83%A8%E7%BD%B2nacos%E9%9B%86%E7%BE%A4/</url>
    <content><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p> deployment部署<span id="more"></span></p>
<ul>
<li>k8s集群版本：<code>1.18.8-aliyun.1</code></li>
<li>nacos版本：<code>1.3.2</code></li>
<li>Pod控制器：<code>Deployment</code></li>
<li>服务器数量：<code>3</code></li>
<li>Deployment数量：<code>3</code></li>
<li>数据库版本：<code>阿里云RDS mysql8.0</code></li>
</ul>
<h1 id="初始化sql"><a href="#初始化sql" class="headerlink" title="初始化sql"></a>初始化sql</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE `config_info` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class="line">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class="line">  `group_id` varchar(255) DEFAULT NULL,</span><br><span class="line">  `content` longtext NOT NULL COMMENT &#x27;content&#x27;,</span><br><span class="line">  `md5` varchar(32) DEFAULT NULL COMMENT &#x27;md5&#x27;,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  `src_user` text COMMENT &#x27;source user&#x27;,</span><br><span class="line">  `src_ip` varchar(20) DEFAULT NULL COMMENT &#x27;source ip&#x27;,</span><br><span class="line">  `app_name` varchar(128) DEFAULT NULL,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br><span class="line">  `c_desc` varchar(256) DEFAULT NULL,</span><br><span class="line">  `c_use` varchar(64) DEFAULT NULL,</span><br><span class="line">  `effect` varchar(64) DEFAULT NULL,</span><br><span class="line">  `type` varchar(64) DEFAULT NULL,</span><br><span class="line">  `c_schema` text,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info&#x27;;</span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = config_info_aggr   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `config_info_aggr` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class="line">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class="line">  `group_id` varchar(255) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br><span class="line">  `datum_id` varchar(255) NOT NULL COMMENT &#x27;datum_id&#x27;,</span><br><span class="line">  `content` longtext NOT NULL COMMENT &#x27;内容&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  `app_name` varchar(128) DEFAULT NULL,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;增加租户字段&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = config_info_beta   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `config_info_beta` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class="line">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class="line">  `group_id` varchar(128) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br><span class="line">  `app_name` varchar(128) DEFAULT NULL COMMENT &#x27;app_name&#x27;,</span><br><span class="line">  `content` longtext NOT NULL COMMENT &#x27;content&#x27;,</span><br><span class="line">  `beta_ips` varchar(1024) DEFAULT NULL COMMENT &#x27;betaIps&#x27;,</span><br><span class="line">  `md5` varchar(32) DEFAULT NULL COMMENT &#x27;md5&#x27;,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  `src_user` text COMMENT &#x27;source user&#x27;,</span><br><span class="line">  `src_ip` varchar(20) DEFAULT NULL COMMENT &#x27;source ip&#x27;,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info_beta&#x27;;</span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = config_info_tag   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `config_info_tag` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class="line">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class="line">  `group_id` varchar(128) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,</span><br><span class="line">  `tag_id` varchar(128) NOT NULL COMMENT &#x27;tag_id&#x27;,</span><br><span class="line">  `app_name` varchar(128) DEFAULT NULL COMMENT &#x27;app_name&#x27;,</span><br><span class="line">  `content` longtext NOT NULL COMMENT &#x27;content&#x27;,</span><br><span class="line">  `md5` varchar(32) DEFAULT NULL COMMENT &#x27;md5&#x27;,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  `src_user` text COMMENT &#x27;source user&#x27;,</span><br><span class="line">  `src_ip` varchar(20) DEFAULT NULL COMMENT &#x27;source ip&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info_tag&#x27;;</span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = config_tags_relation   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `config_tags_relation` (</span><br><span class="line">  `id` bigint(20) NOT NULL COMMENT &#x27;id&#x27;,</span><br><span class="line">  `tag_name` varchar(128) NOT NULL COMMENT &#x27;tag_name&#x27;,</span><br><span class="line">  `tag_type` varchar(64) DEFAULT NULL COMMENT &#x27;tag_type&#x27;,</span><br><span class="line">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class="line">  `group_id` varchar(128) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,</span><br><span class="line">  `nid` bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  PRIMARY KEY (`nid`),</span><br><span class="line">  UNIQUE KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_tag_relation&#x27;;</span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = group_capacity   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `group_capacity` (</span><br><span class="line">  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT &#x27;主键ID&#x27;,</span><br><span class="line">  `group_id` varchar(128) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;Group ID，空字符表示整个集群&#x27;,</span><br><span class="line">  `quota` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;配额，0表示使用默认值&#x27;,</span><br><span class="line">  `usage` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;使用量&#x27;,</span><br><span class="line">  `max_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br><span class="line">  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;聚合子配置最大个数，，0表示使用默认值&#x27;,</span><br><span class="line">  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br><span class="line">  `max_history_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;最大变更历史数量&#x27;,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_group_id` (`group_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;集群、各Group容量信息表&#x27;;</span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = his_config_info   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `his_config_info` (</span><br><span class="line">  `id` bigint(64) unsigned NOT NULL,</span><br><span class="line">  `nid` bigint(20) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `data_id` varchar(255) NOT NULL,</span><br><span class="line">  `group_id` varchar(128) NOT NULL,</span><br><span class="line">  `app_name` varchar(128) DEFAULT NULL COMMENT &#x27;app_name&#x27;,</span><br><span class="line">  `content` longtext NOT NULL,</span><br><span class="line">  `md5` varchar(32) DEFAULT NULL,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">  `src_user` text,</span><br><span class="line">  `src_ip` varchar(20) DEFAULT NULL,</span><br><span class="line">  `op_type` char(10) DEFAULT NULL,</span><br><span class="line">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br><span class="line">  PRIMARY KEY (`nid`),</span><br><span class="line">  KEY `idx_gmt_create` (`gmt_create`),</span><br><span class="line">  KEY `idx_gmt_modified` (`gmt_modified`),</span><br><span class="line">  KEY `idx_did` (`data_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;多租户改造&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/******************************************/</span><br><span class="line">/*   数据库全名 = nacos_config   */</span><br><span class="line">/*   表名称 = tenant_capacity   */</span><br><span class="line">/******************************************/</span><br><span class="line">CREATE TABLE `tenant_capacity` (</span><br><span class="line">  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT &#x27;主键ID&#x27;,</span><br><span class="line">  `tenant_id` varchar(128) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;Tenant ID&#x27;,</span><br><span class="line">  `quota` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;配额，0表示使用默认值&#x27;,</span><br><span class="line">  `usage` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;使用量&#x27;,</span><br><span class="line">  `max_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br><span class="line">  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;聚合子配置最大个数&#x27;,</span><br><span class="line">  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br><span class="line">  `max_history_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;最大变更历史数量&#x27;,</span><br><span class="line">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;租户容量信息表&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE `tenant_info` (</span><br><span class="line">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class="line">  `kp` varchar(128) NOT NULL COMMENT &#x27;kp&#x27;,</span><br><span class="line">  `tenant_id` varchar(128) default &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,</span><br><span class="line">  `tenant_name` varchar(128) default &#x27;&#x27; COMMENT &#x27;tenant_name&#x27;,</span><br><span class="line">  `tenant_desc` varchar(256) DEFAULT NULL COMMENT &#x27;tenant_desc&#x27;,</span><br><span class="line">  `create_source` varchar(32) DEFAULT NULL COMMENT &#x27;create_source&#x27;,</span><br><span class="line">  `gmt_create` bigint(20) NOT NULL COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">  `gmt_modified` bigint(20) NOT NULL COMMENT &#x27;修改时间&#x27;,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),</span><br><span class="line">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;tenant_info&#x27;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `users` (</span><br><span class="line">	`username` varchar(50) NOT NULL PRIMARY KEY,</span><br><span class="line">	`password` varchar(500) NOT NULL,</span><br><span class="line">	`enabled` boolean NOT NULL</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">CREATE TABLE `roles` (</span><br><span class="line">	`username` varchar(50) NOT NULL,</span><br><span class="line">	`role` varchar(50) NOT NULL,</span><br><span class="line">	UNIQUE INDEX `idx_user_role` (`username` ASC, `role` ASC) USING BTREE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">CREATE TABLE `permissions` (</span><br><span class="line">    `role` varchar(50) NOT NULL,</span><br><span class="line">    `resource` varchar(255) NOT NULL,</span><br><span class="line">    `action` varchar(8) NOT NULL,</span><br><span class="line">    UNIQUE INDEX `uk_role_permission` (`role`,`resource`,`action`) USING BTREE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">INSERT INTO users (username, password, enabled) VALUES (&#x27;nacos&#x27;, &#x27;$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu&#x27;, TRUE);</span><br><span class="line"></span><br><span class="line">INSERT INTO roles (username, role) VALUES (&#x27;nacos&#x27;, &#x27;ROLE_ADMIN&#x27;);</span><br></pre></td></tr></table></figure>

<h1 id="YAML文件"><a href="#YAML文件" class="headerlink" title="YAML文件"></a>YAML文件</h1><h2 id="configmap"><a href="#configmap" class="headerlink" title="configmap"></a>configmap</h2><ul>
<li>自行调整数据库连接信息</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap </span><br><span class="line">metadata:</span><br><span class="line">  name: nacos-cloud-config</span><br><span class="line">  namespace: pro</span><br><span class="line">data: </span><br><span class="line">  cluster.conf: |</span><br><span class="line">        192.168.10.1:8848</span><br><span class="line">        192.168.10.2:8848</span><br><span class="line">        192.168.10.3:8848</span><br><span class="line">  application.properties: |</span><br><span class="line">        server.contextPath=/nacos</span><br><span class="line">        server.servlet.contextPath=/nacos</span><br><span class="line">        server.port=8848</span><br><span class="line">        management.metrics.export.elastic.enabled=false</span><br><span class="line">        management.metrics.export.influx.enabled=false</span><br><span class="line">        server.tomcat.accesslog.enabled=true</span><br><span class="line">        server.tomcat.accesslog.pattern=%h %l %u %t &quot;%r&quot; %s %b %D %&#123;User-Agent&#125;i</span><br><span class="line">        server.tomcat.basedir=</span><br><span class="line">        nacos.security.ignore.urls=/,/**/*.css,/**/*.js,/**/*.html,/**/*.map,/**/*.svg,/**/*.png,/**/*.ico,/console-fe/public/**,/v1/auth/login,/v1/console/health/**,/v1/cs/**,/v1/ns/**,/v1/cmdb/**,/actuator/**,/v1/console/server/**</span><br><span class="line">        spring.datasource.platform=mysql</span><br><span class="line">        db.num=1</span><br><span class="line">        db.url.0=jdbc:mysql://数据库地址:3306/数据名?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true</span><br><span class="line">        db.user=</span><br><span class="line">        db.password=</span><br><span class="line">  nacos-logback.xml: |</span><br><span class="line">        &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">        &lt;configuration scan=&quot;true&quot; scanPeriod=&quot;10 seconds&quot;&gt;</span><br><span class="line"></span><br><span class="line">                &lt;springProperty scope=&quot;context&quot; name=&quot;logPath&quot; source=&quot;nacos.logs.path&quot; defaultValue=&quot;$&#123;nacos.home&#125;/logs&quot;/&gt;</span><br><span class="line">                &lt;property name=&quot;LOG_HOME&quot; value=&quot;$&#123;logPath&#125;&quot;/&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;cmdb-main&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;nacos.home&#125;/logs/cmdb-main.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;nacos.home&#125;/logs/cmdb-main.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;2GB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;7GB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;CONSOLE&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;naming-server&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/naming-server.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/naming-server.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;7GB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;async-naming-server&quot; class=&quot;ch.qos.logback.classic.AsyncAppender&quot;&gt;</span><br><span class="line">                        &lt;discardingThreshold&gt;0&lt;/discardingThreshold&gt;</span><br><span class="line">                        &lt;queueSize&gt;1024&lt;/queueSize&gt;</span><br><span class="line">                        &lt;neverBlock&gt;true&lt;/neverBlock&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;naming-server&quot;/&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;naming-raft&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/naming-raft.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/naming-raft.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;3GB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;async-naming-raft&quot; class=&quot;ch.qos.logback.classic.AsyncAppender&quot;&gt;</span><br><span class="line">                        &lt;discardingThreshold&gt;0&lt;/discardingThreshold&gt;</span><br><span class="line">                        &lt;queueSize&gt;1024&lt;/queueSize&gt;</span><br><span class="line">                        &lt;neverBlock&gt;true&lt;/neverBlock&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;naming-raft&quot;/&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;naming-distro&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/naming-distro.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/naming-distro.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;3GB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;async-naming-distro&quot; class=&quot;ch.qos.logback.classic.AsyncAppender&quot;&gt;</span><br><span class="line">                        &lt;discardingThreshold&gt;0&lt;/discardingThreshold&gt;</span><br><span class="line">                        &lt;queueSize&gt;1024&lt;/queueSize&gt;</span><br><span class="line">                        &lt;neverBlock&gt;true&lt;/neverBlock&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;naming-distro&quot;/&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;naming-event&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/naming-event.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/naming-event.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;3GB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;async-naming-event&quot; class=&quot;ch.qos.logback.classic.AsyncAppender&quot;&gt;</span><br><span class="line">                        &lt;discardingThreshold&gt;0&lt;/discardingThreshold&gt;</span><br><span class="line">                        &lt;queueSize&gt;1024&lt;/queueSize&gt;</span><br><span class="line">                        &lt;neverBlock&gt;true&lt;/neverBlock&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;naming-event&quot;/&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;naming-push&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/naming-push.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/naming-push.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;3GB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line">                &lt;appender name=&quot;naming-rt&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/naming-rt.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/naming-rt.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;3GB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%msg%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;naming-performance&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/naming-performance.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/naming-performance.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;3GB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;!--config module logback config--&gt;</span><br><span class="line">                &lt;appender name=&quot;dumpFile&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/config-dump.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/config-dump.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;2GB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;7GB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line">                &lt;appender name=&quot;pullFile&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/config-pull.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/config-pull.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;20MB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;128MB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line">                &lt;appender name=&quot;fatalFile&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/config-fatal.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/config-fatal.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;20MB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;128MB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line">                &lt;appender name=&quot;memoryFile&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/config-memory.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/config-memory.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;20MB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;128MB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line">                &lt;appender name=&quot;pullCheckFile&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/config-pull-check.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/config-pull-check.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;3GB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%msg%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;clientLog&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/config-client-request.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/config-client-request.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;2GB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;7GB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date|%msg%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;traceLog&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/config-trace.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/config-trace.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;2GB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;7GB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date|%msg%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;notifyLog&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/config-notify.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/config-notify.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;3GB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;startLog&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/config-server.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/config-server.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;50MB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;512MB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;rootFile&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/nacos.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/nacos.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;50MB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;512MB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name=&quot;nacos-address&quot;</span><br><span class="line">                                  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;/nacos-address.log&lt;/file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;/append&gt;</span><br><span class="line">                        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;/nacos-address.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;/fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;2GB&lt;/maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;/MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;7GB&lt;/totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;/cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;/rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;/Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;/charset&gt;</span><br><span class="line">                        &lt;/encoder&gt;</span><br><span class="line">                &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.address.main&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;nacos-address&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.cmdb.main&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;cmdb-main&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.naming.main&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;async-naming-server&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.naming.raft&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;async-naming-raft&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.naming.distro&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;async-naming-distro&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.naming.event&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;async-naming-event&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.naming.push&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;naming-push&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.naming.rt&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;naming-rt&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.naming.performance&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;naming-performance&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.config.dumpLog&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;dumpFile&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.config.pullLog&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;pullFile&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.config.pullCheckLog&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;pullCheckFile&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.config.fatal&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;fatalFile&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.config.monitorLog&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;memoryFile&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.config.clientLog&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;info&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;clientLog&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.config.notifyLog&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;notifyLog&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.config.traceLog&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;info&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;traceLog&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.config.startLog&quot; additivity=&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;startLog&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;springProfile name=&quot;standalone&quot;&gt;</span><br><span class="line">                        &lt;logger name=&quot;org.springframework&quot;&gt;</span><br><span class="line">                                &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;</span><br><span class="line">                                &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">                        &lt;logger name=&quot;org.apache.catalina.startup.DigesterFactory&quot;&gt;</span><br><span class="line">                                &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;</span><br><span class="line">                                &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">                        &lt;logger name=&quot;org.apache.catalina.util.LifecycleBase&quot;&gt;</span><br><span class="line">                                &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;</span><br><span class="line">                                &lt;level value=&quot;ERROR&quot;/&gt;</span><br><span class="line">                        &lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">                        &lt;logger name=&quot;org.apache.coyote.http11.Http11NioProtocol&quot;&gt;</span><br><span class="line">                                &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;</span><br><span class="line">                                &lt;level value=&quot;WARN&quot;/&gt;</span><br><span class="line">                        &lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">                        &lt;logger name=&quot;org.apache.tomcat.util.net.NioSelectorPool&quot;&gt;</span><br><span class="line">                                &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;</span><br><span class="line">                                &lt;level value=&quot;WARN&quot;/&gt;</span><br><span class="line">                        &lt;/logger&gt;</span><br><span class="line">                &lt;/springProfile&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name=&quot;com.alibaba.nacos.core.listener.StartingSpringApplicationRunListener&quot;&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                &lt;/logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;root&gt;</span><br><span class="line">                        &lt;level value=&quot;INFO&quot;/&gt;</span><br><span class="line">                        &lt;appender-ref ref=&quot;rootFile&quot;/&gt;</span><br><span class="line">                &lt;/root&gt;</span><br><span class="line">        &lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<h2 id="deploy"><a href="#deploy" class="headerlink" title="deploy"></a>deploy</h2><ul>
<li><p>namespace：pro</p>
</li>
<li><p>查看集群leader</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl -X GET &#x27;127.0.0.1:8848/nacos/v1/ns/raft/leader&#x27;</span><br></pre></td></tr></table></figure>
</li>
<li><p>确保配置存在于指定namespace，而非public</p>
</li>
<li><p>确保服务指定的namespace id正确无误</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: deploy-nacos-cloud-1</span><br><span class="line">  labels:</span><br><span class="line">    name: deploy-nacos-cloud-1</span><br><span class="line">  namespace: pro</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: nacos-cloud-1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nacos-cloud-1</span><br><span class="line">        cloud-name: nacos-cloud</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                  - key: cloud-name</span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                      - nacos-cloud</span><br><span class="line">              topologyKey: kubernetes.io/hostname</span><br><span class="line">      containers:</span><br><span class="line">      - name: nacos-cloud-1</span><br><span class="line">        image: nacos-server:1.3.2</span><br><span class="line">        env:</span><br><span class="line">        - name: NACOS_SERVER_IP</span><br><span class="line">          value: 192.168.10.1</span><br><span class="line">        - name: JVM_XMS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: JVM_XMX</span><br><span class="line">          value: 512m</span><br><span class="line">        - name: JVM_XMN</span><br><span class="line">          value: 192m</span><br><span class="line">        - name: JVM_MS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: JVM_MMS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: TZ</span><br><span class="line">          value: Asia/Shanghai</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8848</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /nacos/</span><br><span class="line">            port: 8848</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 3</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /nacos/</span><br><span class="line">            port: 8848</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 3</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &quot;/home/nacos/conf&quot;</span><br><span class="line">          name: nacos-cloud-config</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nacos-cloud-config</span><br><span class="line">          configMap:   </span><br><span class="line">            name: nacos-cloud-config</span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: svc-nacos-cloud-1</span><br><span class="line">  labels:</span><br><span class="line">    name: svc-nacos-cloud-1</span><br><span class="line">  namespace: pro</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 192.168.10.1</span><br><span class="line">  selector:</span><br><span class="line">    name: nacos-cloud-1</span><br><span class="line">  ports:</span><br><span class="line">  - name: port1</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 8848</span><br><span class="line">    targetPort: 8848</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: deploy-nacos-cloud-2</span><br><span class="line">  labels:</span><br><span class="line">    name: deploy-nacos-cloud-2</span><br><span class="line">  namespace: pro</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: nacos-cloud-2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nacos-cloud-2</span><br><span class="line">        cloud-name: nacos-cloud</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                  - key: cloud-name</span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                      - nacos-cloud</span><br><span class="line">              topologyKey: kubernetes.io/hostname</span><br><span class="line">      containers:</span><br><span class="line">      - name: nacos-cloud-2</span><br><span class="line">        image: nacos-server:1.3.2</span><br><span class="line">        env:</span><br><span class="line">        - name: NACOS_SERVER_IP</span><br><span class="line">          value: 192.168.10.2</span><br><span class="line">        - name: JVM_XMS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: JVM_XMX</span><br><span class="line">          value: 512m</span><br><span class="line">        - name: JVM_XMN</span><br><span class="line">          value: 192m</span><br><span class="line">        - name: JVM_MS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: JVM_MMS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: TZ</span><br><span class="line">          value: Asia/Shanghai</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8848</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /nacos/</span><br><span class="line">            port: 8848</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 3</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /nacos/</span><br><span class="line">            port: 8848</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 3</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &quot;/home/nacos/conf&quot;</span><br><span class="line">          name: nacos-cloud-config</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nacos-cloud-config</span><br><span class="line">          configMap:   </span><br><span class="line">            name: nacos-cloud-config</span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: svc-nacos-cloud-2</span><br><span class="line">  labels:</span><br><span class="line">    name: svc-nacos-cloud-2</span><br><span class="line">  namespace: pro</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 192.168.10.2</span><br><span class="line">  selector:</span><br><span class="line">    name: nacos-cloud-2</span><br><span class="line">  ports:</span><br><span class="line">  - name: port1</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 8848</span><br><span class="line">    targetPort: 8848</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: deploy-nacos-cloud-3</span><br><span class="line">  labels:</span><br><span class="line">    name: deploy-nacos-cloud-3</span><br><span class="line">  namespace: pro</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: nacos-cloud-3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nacos-cloud-3</span><br><span class="line">        cloud-name: nacos-cloud</span><br><span class="line">    spec:</span><br><span class="line">      affinity:        </span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                  - key: cloud-name</span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                      - nacos-cloud</span><br><span class="line">              topologyKey: kubernetes.io/hostname</span><br><span class="line">      containers:</span><br><span class="line">      - name: nacos-cloud-3</span><br><span class="line">        image: nacos-server:1.3.2</span><br><span class="line">        env:</span><br><span class="line">        - name: NACOS_SERVER_IP</span><br><span class="line">          value: 192.168.10.3</span><br><span class="line">        - name: JVM_XMS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: JVM_XMX</span><br><span class="line">          value: 512m</span><br><span class="line">        - name: JVM_XMN</span><br><span class="line">          value: 192m</span><br><span class="line">        - name: JVM_MS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: JVM_MMS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: TZ</span><br><span class="line">          value: Asia/Shanghai</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8848</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /nacos/</span><br><span class="line">            port: 8848</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 3</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /nacos/</span><br><span class="line">            port: 8848</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 3</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &quot;/home/nacos/conf&quot;</span><br><span class="line">          name: nacos-cloud-config</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nacos-cloud-config</span><br><span class="line">          configMap:   </span><br><span class="line">            name: nacos-cloud-config</span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: svc-nacos-cloud-3</span><br><span class="line">  labels:</span><br><span class="line">    name: svc-nacos-cloud-3</span><br><span class="line">  namespace: pro</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 192.168.10.3</span><br><span class="line">  selector:</span><br><span class="line">    name: nacos-cloud-3</span><br><span class="line">  ports:</span><br><span class="line">  - name: port1</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 8848</span><br><span class="line">    targetPort: 8848</span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nacos-svc</span><br><span class="line">  labels:</span><br><span class="line">    name: nacos-svc</span><br><span class="line">  namespace: pro</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    cloud-name: nacos-cloud</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - name: port1</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 8848</span><br><span class="line">    targetPort: 8848</span><br><span class="line">    nodePort: 30848</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>k8s</tag>
      </tags>
  </entry>
  <entry>
    <title>nginx替换响应内容</title>
    <url>/2023/05/22/nginx%E6%9B%BF%E6%8D%A2%E5%93%8D%E5%BA%94%E5%86%85%E5%AE%B9/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><ul>
<li>ckeditor公式插件使用限制，通过nginx方向代理替换域名后部分请求接口在响应内容里，因XmlHttpRequest同源策略被拦截，因此还需要替换响应内容。<span id="more"></span></li>
</ul>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><h4 id="简单替换模块-ngx-http-sub-module："><a href="#简单替换模块-ngx-http-sub-module：" class="headerlink" title="简单替换模块 ngx_http_sub_module："></a>简单替换模块 ngx_http_sub_module：</h4><ol>
<li><p>介绍：</p>
<p>ngx_http_sub_module模块是一个过滤器，它修改网站响应内容中的字符串。这个模块已经内置在nginx中，但是默认未安装，需要安装需要加上配置参数：–with-http_sub_module 如果已经安装nginx,只需要再添加这个模块就可以了。</p>
</li>
<li><p>常用指令：</p>
<p>2.1 sub_filter指令： sub_filter string（原字符串） replacement（用于替换的字符串）;</p>
<p>　 用于设置需要使用说明字符串替换说明字符串.string是要被替换的字符串，replacement是 新的字符串，它里面可以带变量。</p>
<p>2.2 sub_filter_last_modified指令： sub_filter_last_modified on | off;</p>
<p>　 用于设置网页内替换后是否修改 可在nginx.conf的 http, server, location三个位置配置使 用，默认值是off；</p>
<p>2.3 sub_filter_once指令：sub_filter_once on | off;</p>
<p>　 用于设置字符串替换次数，默认只替换一次。如果是on，默认只替换第一次匹配到的到字 符，如果是off，那么所有匹配到的字符都会被替换；</p>
<p>2.4 sub_filter_types指令：sub_filter_types *</p>
<p> 用于指定需要被替换的MIME类型,默认为“text&#x2F;html”，如果制定为*，那么所有的；</p>
</li>
<li><p>说明：</p>
<p>3.1以上指令可在nginx.conf的http, server, location三个位置配置使用；</p>
<p>3.2此模块替换不区分大小写；</p>
<p>3.3支持中文替换；　</p>
</li>
<li><p>示例：</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">location = /demo/editor/editor &#123;</span><br><span class="line">  alias /html/js/editor;</span><br><span class="line">&#125;</span><br><span class="line">location = /demo/plugins/app/configurationjs &#123;</span><br><span class="line">  sub_filter_types * ;</span><br><span class="line">  #add_header Access-Control-Allow-Origin *;跨域配置视情况加，不然会出现请求头重复</span><br><span class="line">  proxy_set_header Referer &quot;www.wiris.net&quot;;</span><br><span class="line">  proxy_pass https://www.wiris.net;</span><br><span class="line">  sub_filter &#x27;www.wiris.net&#x27; &#x27;wiris.aaa.com&#x27;;</span><br><span class="line">&#125;</span><br><span class="line">location ^~ /demo/ &#123;</span><br><span class="line">  proxy_set_header Referer &quot;www.wiris.net&quot;;</span><br><span class="line">  proxy_pass https://www.wiris.net;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注：实际在替换某些类型时没替换成功，需要下载到本地</p>
<h4 id="nginx配置返回json"><a href="#nginx配置返回json" class="headerlink" title="nginx配置返回json"></a>nginx配置返回json</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">location ~ ^/get_json &#123;</span><br><span class="line">  default_type application/json;</span><br><span class="line">  return 200 &#x27;&#123;&quot;status&quot;:&quot;success&quot;,&quot;result&quot;:&quot;nginx json&quot;&#125;&#x27;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>nginx</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>nginx配置vue history模式</title>
    <url>/2023/05/22/nginx%E9%85%8D%E7%BD%AEvue_history%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><ul>
<li>nginx配置vue history后，页面加载空白<span id="more"></span></li>
</ul>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>1、一般情况使用配置一即可；</p>
<p>2、如果VUE应用没有发布在域名的目录根下，比如<a href="http://xxx.com/wx/%EF%BC%8C%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8%E9%85%8D%E7%BD%AE%E4%BA%8C%EF%BC%9B">http://xxx.com/wx/，需要使用配置二；</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">配置一：</span><br><span class="line">   location / &#123;</span><br><span class="line">     try_files $uri $uri/ /index.html;</span><br><span class="line">   &#125;</span><br><span class="line">配置二：</span><br><span class="line"> location /wx &#123;</span><br><span class="line">   root   /data/nginx/html;</span><br><span class="line">   index  index.html index.htm;</span><br><span class="line">   if (!-e $request_filename) &#123;</span><br><span class="line">     rewrite ^/(.*) /wx/index.html last;</span><br><span class="line">     break;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>注：vue配置，base路径同域名访问路径</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">base: &#x27;/wx&#x27;,</span><br><span class="line">mode: &#x27;history&#x27;,</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>nginx</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>openvpn搭建</title>
    <url>/2023/05/22/openvpn%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul>
<li>此法用于客户端通过OpenVPN服务器访问服务器所在私网网段<span id="more"></span></li>
<li>OpenVPN服务器操作系统<code>centos7.8</code></li>
<li>OpenVPN版本<code>2.4.9</code></li>
<li>easy-rsa版本<code>3.0.8</code></li>
<li>使用<code>tun</code>模式</li>
<li>客户端IP地址池<code>10.8.0.0/24</code></li>
<li>多个客户端直接可以通过OpenVPN实现通信</li>
</ul>
<h1 id="准备操作"><a href="#准备操作" class="headerlink" title="准备操作"></a>准备操作</h1><h2 id="添加EPEL源"><a href="#添加EPEL源" class="headerlink" title="添加EPEL源"></a>添加EPEL源</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install epel-release -y</span><br></pre></td></tr></table></figure>

<h2 id="替换为阿里云的源"><a href="#替换为阿里云的源" class="headerlink" title="替换为阿里云的源"></a>替换为阿里云的源</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sed -e &#x27;s,^#baseurl,baseurl,g&#x27; \</span><br><span class="line">    -e &#x27;s,^metalink,#metalink,g&#x27; \</span><br><span class="line">    -e &#x27;s,^mirrorlist=,#mirrorlist=,g&#x27; \</span><br><span class="line">    -e &#x27;s,http://download.fedoraproject.org/pub,https://mirrors.aliyun.com,g&#x27; \</span><br><span class="line">    -i /etc/yum.repos.d/epel.repo</span><br></pre></td></tr></table></figure>

<h2 id="更新软件"><a href="#更新软件" class="headerlink" title="更新软件"></a>更新软件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum makecache</span><br><span class="line">yum update -y</span><br></pre></td></tr></table></figure>

<h2 id="修改sysctl参数"><a href="#修改sysctl参数" class="headerlink" title="修改sysctl参数"></a>修改sysctl参数</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">echo &quot;net.ipv4.ip_forward = 1&quot; &gt;&gt;/etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<h2 id="安装OpenVPN软件"><a href="#安装OpenVPN软件" class="headerlink" title="安装OpenVPN软件"></a>安装OpenVPN软件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">yum install -y openvpn easy-rsa lrzsz iptables-services</span><br></pre></td></tr></table></figure>

<h1 id="配置服务器证书"><a href="#配置服务器证书" class="headerlink" title="配置服务器证书"></a>配置服务器证书</h1><h2 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h2><blockquote>
<p>拷贝easy-rsa的文件到&#x2F;etc&#x2F;openvpn下</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cp -r /usr/share/easy-rsa/3.0.8 /etc/openvpn/easy-rsa</span><br><span class="line">cp /usr/share/doc/easy-rsa-3.0.8/vars.example /etc/openvpn/easy-rsa/vars</span><br></pre></td></tr></table></figure>

<h2 id="修改vars"><a href="#修改vars" class="headerlink" title="修改vars"></a>修改vars</h2><blockquote>
<p>编辑vars文件</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/openvpn/easy-rsa/vars</span><br></pre></td></tr></table></figure>

<blockquote>
<p>修改以下几项</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#set_var EASYRSA_REQ_COUNTRY     &quot;US&quot;</span><br><span class="line">#set_var EASYRSA_REQ_PROVINCE    &quot;California&quot;</span><br><span class="line">#set_var EASYRSA_REQ_CITY        &quot;San Francisco&quot;</span><br><span class="line">#set_var EASYRSA_REQ_ORG         &quot;Copyleft Certificate Co&quot;</span><br><span class="line">#set_var EASYRSA_REQ_EMAIL       &quot;me@example.net&quot;</span><br><span class="line">#set_var EASYRSA_REQ_OU          &quot;My Organizational Unit&quot;</span><br><span class="line">#set_var EASYRSA_KEY_SIZE        4096</span><br><span class="line">#set_var EASYRSA_ALGO            rsa</span><br><span class="line">#set_var EASYRSA_CA_EXPIRE       3650</span><br><span class="line">#set_var EASYRSA_CERT_EXPIRE     3650</span><br><span class="line">#set_var EASYRSA_CERT_RENEW      180</span><br><span class="line">#set_var EASYRSA_CRL_DAYS        60</span><br></pre></td></tr></table></figure>

<h2 id="初始化PKI和CA"><a href="#初始化PKI和CA" class="headerlink" title="初始化PKI和CA"></a>初始化PKI和CA</h2><h3 id="切换目录"><a href="#切换目录" class="headerlink" title="切换目录"></a>切换目录</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd /etc/openvpn/easy-rsa</span><br></pre></td></tr></table></figure>

<h3 id="创建PKI"><a href="#创建PKI" class="headerlink" title="创建PKI"></a>创建PKI</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./easyrsa init-pki</span><br></pre></td></tr></table></figure>

<h3 id="创建CA"><a href="#创建CA" class="headerlink" title="创建CA"></a>创建CA</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./easyrsa build-ca nopass</span><br></pre></td></tr></table></figure>

<h2 id="创建服务器证书"><a href="#创建服务器证书" class="headerlink" title="创建服务器证书"></a>创建服务器证书</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./easyrsa build-server-full openvpn-server nopass</span><br></pre></td></tr></table></figure>

<h2 id="创建DH和CRL证书"><a href="#创建DH和CRL证书" class="headerlink" title="创建DH和CRL证书"></a>创建DH和CRL证书</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">./easyrsa gen-dh</span><br><span class="line">./easyrsa gen-crl</span><br></pre></td></tr></table></figure>

<h2 id="拷贝证书"><a href="#拷贝证书" class="headerlink" title="拷贝证书"></a>拷贝证书</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /etc/openvpn/pki</span><br><span class="line">cp /etc/openvpn/easy-rsa/pki/ca.crt \</span><br><span class="line">   /etc/openvpn/easy-rsa/pki/dh.pem \</span><br><span class="line">   /etc/openvpn/easy-rsa/pki/issued/openvpn-server.crt \</span><br><span class="line">   /etc/openvpn/easy-rsa/pki/private/openvpn-server.key \</span><br><span class="line">   /etc/openvpn/pki/</span><br><span class="line">ln -sv /etc/openvpn/easy-rsa/pki/crl.pem /etc/openvpn/pki/crl.pem</span><br><span class="line">chown -R root:openvpn /etc/openvpn/pki</span><br></pre></td></tr></table></figure>

<h2 id="创建ta-key"><a href="#创建ta-key" class="headerlink" title="创建ta.key"></a>创建ta.key</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">openvpn --genkey --secret /etc/openvpn/pki/ta.key</span><br></pre></td></tr></table></figure>

<h1 id="配置OpenVPN"><a href="#配置OpenVPN" class="headerlink" title="配置OpenVPN"></a>配置OpenVPN</h1><h2 id="创建日志目录"><a href="#创建日志目录" class="headerlink" title="创建日志目录"></a>创建日志目录</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /var/log/openvpn</span><br><span class="line">chown -R openvpn:openvpn /var/log/openvpn</span><br></pre></td></tr></table></figure>

<h2 id="创建客户端配置目录"><a href="#创建客户端配置目录" class="headerlink" title="创建客户端配置目录"></a>创建客户端配置目录</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkdir -p /etc/openvpn/client/&#123;config,user&#125;</span><br><span class="line">chown -R root:openvpn /etc/openvpn/client/&#123;config,user&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置OpenVPN服务器端"><a href="#配置OpenVPN服务器端" class="headerlink" title="配置OpenVPN服务器端"></a>配置OpenVPN服务器端</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/openvpn/server/srv.conf</span><br></pre></td></tr></table></figure>

<blockquote>
<p>下面内容按需更改</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 监听地址</span><br><span class="line">local 0.0.0.0</span><br><span class="line"># 监听端口</span><br><span class="line">port 51194</span><br><span class="line"># 通信协议</span><br><span class="line">proto tcp</span><br><span class="line"># TUN模式还是TAP模式</span><br><span class="line">dev tun</span><br><span class="line"># 证书</span><br><span class="line">ca         /etc/openvpn/pki/ca.crt</span><br><span class="line">cert       /etc/openvpn/pki/openvpn-server.crt</span><br><span class="line">key        /etc/openvpn/pki/openvpn-server.key</span><br><span class="line">dh         /etc/openvpn/pki/dh.pem</span><br><span class="line">crl-verify /etc/openvpn/pki/crl.pem</span><br><span class="line"># 禁用OpenVPN自定义缓冲区大小，由操作系统控制</span><br><span class="line">sndbuf 0</span><br><span class="line">rcvbuf 0</span><br><span class="line"># TLS rules “client” | “server”</span><br><span class="line">remote-cert-tls  &quot;client&quot;</span><br><span class="line"># TLS认证</span><br><span class="line">tls-auth /etc/openvpn/pki/ta.key</span><br><span class="line"># TLS最小版本</span><br><span class="line">#tls-version-min &quot;1.2&quot;</span><br><span class="line"># 重新协商数据交换的key，默认3600</span><br><span class="line">#reneg-sec 3600</span><br><span class="line"># 在此文件中维护客户端与虚拟IP地址之间的关联记录</span><br><span class="line"># 如果OpenVPN重启，重新连接的客户端可以被分配到先前分配的虚拟IP地址</span><br><span class="line">ifconfig-pool-persist /etc/openvpn/ipp.txt</span><br><span class="line"># 配置client配置文件</span><br><span class="line">client-config-dir /etc/openvpn/client/config</span><br><span class="line"># 该网段为 open VPN 虚拟网卡网段，不要和内网网段冲突即可。</span><br><span class="line">server 10.8.0.0 255.255.255.0</span><br><span class="line"># 给客户端推送自定义路由</span><br><span class="line">#push &quot;route 192.168.0.0 255.255.255.0&quot;</span><br><span class="line"># 所有客户端的默认网关都将重定向到VPN</span><br><span class="line">#push &quot;redirect-gateway def1 bypass-dhcp&quot;  </span><br><span class="line"># 向客户端推送DNS配置</span><br><span class="line">#push &quot;dhcp-option DNS 223.5.5.5&quot;</span><br><span class="line">#push &quot;dhcp-option DNS 223.6.6.6&quot;</span><br><span class="line"># 允许客户端之间互相访问</span><br><span class="line">client-to-client</span><br><span class="line"># 限制最大客户端数量</span><br><span class="line">#max-clients 10</span><br><span class="line"># 客户端连接时运行脚本</span><br><span class="line">#client-connect ovpns.script</span><br><span class="line"># 客户端断开连接时运行脚本</span><br><span class="line">#client-disconnect ovpns.script</span><br><span class="line"># 保持连接时间</span><br><span class="line">keepalive 20 120</span><br><span class="line"># 开启vpn压缩</span><br><span class="line">comp-lzo</span><br><span class="line"># 允许多人使用同一个证书连接VPN，不建议使用，注释状态</span><br><span class="line">#duplicate-cn</span><br><span class="line"># 运行用户</span><br><span class="line">user openvpn</span><br><span class="line">#运行组</span><br><span class="line">group openvpn</span><br><span class="line"># 持久化选项可以尽量避免访问那些在重启之后由于用户权限降低而无法访问的某些资源</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line"># 显示当前的连接状态</span><br><span class="line">status      /var/log/openvpn/openvpn-status.log</span><br><span class="line"># 日志路径，不指定文件路径时输出到控制台</span><br><span class="line"># log代表每次启动时清空日志文件</span><br><span class="line">#log        /var/log/openvpn/openvpn.log</span><br><span class="line"># log-append代表追加写入到日志文件</span><br><span class="line">#log-append  /var/log/openvpn/openvpn.log</span><br><span class="line"># 日志级别</span><br><span class="line">verb 4</span><br><span class="line"># 忽略过多的重复信息，相同类别的信息只有前20条会输出到日志文件中</span><br><span class="line">mute 20</span><br></pre></td></tr></table></figure>

<h2 id="启动OpenVPN-server"><a href="#启动OpenVPN-server" class="headerlink" title="启动OpenVPN-server"></a>启动OpenVPN-server</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">chown -R root:openvpn /etc/openvpn</span><br><span class="line">systemctl enable openvpn-server@srv.service</span><br><span class="line">systemctl start openvpn-server@srv.service</span><br></pre></td></tr></table></figure>

<h2 id="开启iptables策略"><a href="#开启iptables策略" class="headerlink" title="开启iptables策略"></a>开启iptables策略</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -j MASQUERADE</span><br><span class="line">iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -d 服务器网段(172.16.0.0/12) -j SNAT --to-source 服务器ip</span><br></pre></td></tr></table></figure>

<h2 id="定期更新CRL"><a href="#定期更新CRL" class="headerlink" title="定期更新CRL"></a>定期更新CRL</h2><h3 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h3><ul>
<li>OpenVPN的server配置里面添加了<code>crl-verify</code>之后，需要给crl定期更新</li>
<li>如果crl文件长期不更新，过期之后，OpenVPN会报无法验证证书，导致无法连接OpenVPN</li>
</ul>
<h3 id="配置systemd-timer"><a href="#配置systemd-timer" class="headerlink" title="配置systemd timer"></a>配置systemd timer</h3><h3 id="定义Service"><a href="#定义Service" class="headerlink" title="定义Service"></a>定义Service</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/easyrsa-gen-crl.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=easyrsa-gen-crl</span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line"># 重新生成CRL文件</span><br><span class="line">ExecStart=/etc/openvpn/easy-rsa/easyrsa gen-crl</span><br><span class="line"># 命令完成之后重启OpenVPN服务</span><br><span class="line">ExecStartPost=/usr/bin/systemctl restart openvpn-server@srv.service</span><br><span class="line">WorkingDirectory=/etc/openvpn/easy-rsa</span><br></pre></td></tr></table></figure>

<h3 id="定义timer"><a href="#定义timer" class="headerlink" title="定义timer"></a>定义timer</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/easyrsa-gen-crl.timer</span><br><span class="line">[Unit]</span><br><span class="line">Description=easyrsa-gen-crl</span><br><span class="line"></span><br><span class="line">[Timer]</span><br><span class="line"># 每周一凌晨4点触发easyrsa-gen-crl.service</span><br><span class="line">OnCalendar=Mon *-*-* 04:00:00</span><br><span class="line">Persistent=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=timers.target</span><br></pre></td></tr></table></figure>

<h3 id="启动timer"><a href="#启动timer" class="headerlink" title="启动timer"></a>启动timer</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl enable easyrsa-gen-crl.timer</span><br><span class="line">systemctl start easyrsa-gen-crl.timer</span><br></pre></td></tr></table></figure>

<h3 id="立刻启动service"><a href="#立刻启动service" class="headerlink" title="立刻启动service"></a>立刻启动service</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl start easyrsa-gen-crl.service</span><br></pre></td></tr></table></figure>

<h3 id="查看Service日志"><a href="#查看Service日志" class="headerlink" title="查看Service日志"></a>查看Service日志</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">journalctl -xfu easyrsa-gen-crl.service</span><br></pre></td></tr></table></figure>

<h3 id="查看timer状态"><a href="#查看timer状态" class="headerlink" title="查看timer状态"></a>查看timer状态</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">systemctl status easyrsa-gen-crl.timer</span><br></pre></td></tr></table></figure>

<h1 id="客户端管理"><a href="#客户端管理" class="headerlink" title="客户端管理"></a>客户端管理</h1><h2 id="客户端配置模板"><a href="#客户端配置模板" class="headerlink" title="客户端配置模板"></a>客户端配置模板</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/openvpn/templates/ovpn.template</span><br><span class="line"># 配置为客户端模式</span><br><span class="line">client</span><br><span class="line"># 与服务器端保持一致</span><br><span class="line">proto tcp</span><br><span class="line"># 与服务器端保持一致</span><br><span class="line">dev tun</span><br><span class="line"># 配置服务器端的地址和端口</span><br><span class="line">remote 服务端ip 51194</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">comp-lzo</span><br><span class="line">nice 0</span><br><span class="line">verb 3</span><br><span class="line">mute 10</span><br><span class="line"># 禁用OpenVPN自定义缓冲区大小，由操作系统控制</span><br><span class="line">sndbuf 0</span><br><span class="line">rcvbuf 0</span><br><span class="line"># 禁止在内存中缓存password</span><br><span class="line">auth-nocache</span><br><span class="line"># TLS rules “client” | “server”</span><br><span class="line">remote-cert-tls server</span><br><span class="line"># 过滤从服务器端发过来的路由规则</span><br><span class="line">#pull-filter ignore redirect-gateway</span><br><span class="line"># 不从服务器端拉取路由规则</span><br><span class="line">#route-nopull</span><br><span class="line"># 手动指定所有流量走VPN</span><br><span class="line">#redirect-gateway def1</span><br><span class="line"># 客户端自定义路由，例如192.168.0.0/24走VPN，192.168.1.0/24不走VPN</span><br><span class="line">#route 192.168.0.0 255.255.255.0 vpn_gateway</span><br><span class="line">#route 192.168.1.0 255.255.255.0 net_gateway</span><br></pre></td></tr></table></figure>

<h2 id="指定客户端推送配置"><a href="#指定客户端推送配置" class="headerlink" title="指定客户端推送配置"></a>指定客户端推送配置</h2><h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/openvpn/templates/ipconfig_push.template</span><br><span class="line"># 给客户端推送固定的IP地址</span><br><span class="line">ifconfig-push #ipaddress# 255.255.255.0</span><br><span class="line"># 给客户端推送路由</span><br><span class="line">#iroute 172.17.0.0 255.255.0.0</span><br></pre></td></tr></table></figure>

<h3 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /etc/openvpn/client/config/user1</span><br><span class="line"># 给客户端推送固定的IP地址10.8.0.100，推送固定ip报错可不配置</span><br><span class="line"># ifconfig-push 10.8.0.100 255.255.255.0</span><br></pre></td></tr></table></figure>

<h2 id="用户管理脚本"><a href="#用户管理脚本" class="headerlink" title="用户管理脚本"></a>用户管理脚本</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">vim /usr/local/bin/ovpn_mgmt.sh</span><br><span class="line">chmod +x /usr/local/bin/ovpn_mgmt.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line"># 定义环境变量</span><br><span class="line">export EASY_RSA_DIR=&quot;/etc/openvpn/easy-rsa&quot;</span><br><span class="line">export CLIENT_CONFIG_DIR=&quot;/etc/openvpn/client/config&quot;</span><br><span class="line">export PKI_DIR=&quot;$&#123;EASY_RSA_DIR&#125;/pki&quot;</span><br><span class="line">export TEMPLATES_DIR=&quot;/etc/openvpn/templates&quot;</span><br><span class="line">export CLIENT_USER_DIR=&quot;/etc/openvpn/client/user&quot;</span><br><span class="line"></span><br><span class="line"># 创建ovpn配置</span><br><span class="line">generate_ovpn() &#123;</span><br><span class="line">	USER_OVPN=&quot;$&#123;CLIENT_USER_DIR&#125;/$&#123;EXPIRED&#125;-$&#123;USER&#125;.ovpn&quot;</span><br><span class="line">	# 根据证书生成对应的ovpn文件</span><br><span class="line">    mkdir -p  $&#123;CLIENT_USER_DIR&#125;/</span><br><span class="line">    cp -f $&#123;TEMPLATES_DIR&#125;/ovpn.template $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;ca&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat $&#123;PKI_DIR&#125;/ca.crt &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;/ca&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;cert&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat $&#123;PKI_DIR&#125;/issued/$&#123;USER&#125;.crt &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;/cert&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;key&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat $&#123;PKI_DIR&#125;/private/$&#123;USER&#125;.key &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;/key&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;tls-auth&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat /etc/openvpn/pki/ta.key &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;/tls-auth&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    sz --binary $&#123;USER_OVPN&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 添加客户端IP</span><br><span class="line">client_ip_config() &#123;</span><br><span class="line">	# 根据ip地址生成对应的client-config</span><br><span class="line">    sed -e &quot;s,#ipaddress#,$&#123;IPADDRESS&#125;,g&quot; \</span><br><span class="line">        $&#123;TEMPLATES_DIR&#125;/ipconfig_push.template \</span><br><span class="line">        &gt; $&#123;CLIENT_CONFIG_DIR&#125;/$&#123;USER&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 生成客户端证书</span><br><span class="line">add_cert() &#123;</span><br><span class="line">	# 切换到easy-rsa目录</span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    $&#123;EASY_RSA_DIR&#125;/easyrsa build-client-full $&#123;USER&#125; nopass</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 注销客户端证书</span><br><span class="line">revoke_cert() &#123;</span><br><span class="line">	# 切换到easy-rsa目录</span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    echo &quot;yes&quot; | $&#123;EASY_RSA_DIR&#125;/easyrsa revoke $&#123;USER&#125;</span><br><span class="line">	$&#123;EASY_RSA_DIR&#125;/easyrsa gen-crl</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 更新客户端证书</span><br><span class="line">renew_cert() &#123;</span><br><span class="line">	# 切换到easy-rsa目录</span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    echo &quot;yes&quot; | $&#123;EASY_RSA_DIR&#125;/easyrsa renew $&#123;USER&#125; nopass</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 检查证书过期时间</span><br><span class="line">check_cert_expired() &#123;</span><br><span class="line">	export EXPIRED=$(date --date=&quot;$(openssl x509 -enddate -noout -in $&#123;PKI_DIR&#125;/issued/$&#123;USER&#125;.crt |cut -d= -f 2)&quot; --iso-8601)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 创建用户</span><br><span class="line">add_user() &#123;</span><br><span class="line">	if [[ -e &quot;$&#123;EASY_RSA_DIR&#125;/pki/reqs/$&#123;USER&#125;.req&quot; ]];then</span><br><span class="line">		read -p&quot;此用户已经申请证书，是否重新生成？[y/n]：&quot; ANSWER</span><br><span class="line">		case $&#123;ANSWER&#125; in</span><br><span class="line">		    y|Y)</span><br><span class="line">		        revoke_cert</span><br><span class="line">		        check_cert_expired</span><br><span class="line">		        client_ip_config</span><br><span class="line">		        add_cert</span><br><span class="line">		        generate_ovpn</span><br><span class="line">		        exit 0</span><br><span class="line">		        ;;</span><br><span class="line">			n|N)</span><br><span class="line">				check_cert_expired</span><br><span class="line">				client_ip_config</span><br><span class="line">				generate_ovpn</span><br><span class="line">				;;</span><br><span class="line">		esac</span><br><span class="line">	else</span><br><span class="line">		add_cert</span><br><span class="line">		check_cert_expired</span><br><span class="line">		client_ip_config</span><br><span class="line">		generate_ovpn</span><br><span class="line">	fi</span><br><span class="line">&#125;</span><br><span class="line"># 删除用户</span><br><span class="line">del_user() &#123;</span><br><span class="line">	revoke_cert</span><br><span class="line">	rm -rf $&#123;CLIENT_USER_DIR&#125;/*$&#123;USER&#125;.ovpn</span><br><span class="line">	rm -rf $&#123;CLIENT_CONFIG_DIR&#125;/$&#123;USER&#125;</span><br><span class="line">&#125;</span><br><span class="line"># 用户旧证过期重新生成证书</span><br><span class="line">renew_user() &#123;</span><br><span class="line">	if [[ -e &quot;$&#123;EASY_RSA_DIR&#125;/pki/reqs/$&#123;USER&#125;.req&quot; ]];then</span><br><span class="line">        renew_cert</span><br><span class="line">        check_cert_expired</span><br><span class="line">        generate_ovpn</span><br><span class="line">    else</span><br><span class="line">    	echo &quot;用户证书不存在！&quot;</span><br><span class="line">    	exit 1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">    # 切换到easy-rsa目录</span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    # 根据传入的method运行对应函数</span><br><span class="line">    $&#123;METHOD&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 获取参数</span><br><span class="line">while getopts &#x27;m:u:i:r&#x27; OPT;do</span><br><span class="line">    case $OPT in</span><br><span class="line">        u)</span><br><span class="line">            USER=&quot;$OPTARG&quot;</span><br><span class="line">            echo &quot;USER=$&#123;USER&#125;&quot;</span><br><span class="line">            ;;</span><br><span class="line">        i)</span><br><span class="line">            IPADDRESS=&quot;$OPTARG&quot;</span><br><span class="line">            echo &quot;IPADDRESS=$&#123;IPADDRESS&#125;&quot;</span><br><span class="line">            ;;</span><br><span class="line">        m)</span><br><span class="line">            METHOD=&quot;$OPTARG&quot;</span><br><span class="line">            echo &quot;METHOD=$&#123;METHOD&#125;&quot;</span><br><span class="line">            ;;</span><br><span class="line">        ?)</span><br><span class="line">            echo &quot;Usage: $(base \&quot;$0\&quot;) -m [add_user|del_user|renew_user] -u USER -i IPADDRESS&quot;</span><br><span class="line">            exit 0</span><br><span class="line">            ;;</span><br><span class="line">    esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">main</span><br></pre></td></tr></table></figure>

<h2 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/local/bin/ovpn_mgmt.sh -m add_user -u USERNAME -i 10.8.0.10</span><br></pre></td></tr></table></figure>

<h2 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a>删除用户</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/usr/local/bin/ovpn_mgmt.sh -m del_user -u USERNAME</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>openvpn</category>
      </categories>
      <tags>
        <tag>openvpn</tag>
      </tags>
  </entry>
  <entry>
    <title>pod访问同一集群下的nginx-controller的SLB不通</title>
    <url>/2023/05/22/pod%E8%AE%BF%E9%97%AE%E5%90%8C%E4%B8%80%E9%9B%86%E7%BE%A4%E4%B8%8B%E7%9A%84nginx-controller%E7%9A%84SLB%E4%B8%8D%E9%80%9A/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>在Kubernetes集群中有部分服务无法访问集群暴露出去的SLB。<span id="more"></span></p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><blockquote>
<p> SLB设置了<code>externalTrafficPolicy: Local</code>类型，这种类型的SLB地址只有在Node中部署了对应的后端Pod，才能被访问。因为SLB的地址是集群外使用，如果集群节点和Pod不能直接访问，请求不会到SLB，会被当作Service的扩展IP地址，被kube-proxy的iptables或ipvs转发。如果刚好集群节点或者Pod所在的节点上没有相应的后端服务Pod，就会发生网络不通的问题，而如果有相应的后端服务Pod，是可以正常访问。</p>
<p> 将LoadBalancer的Service中的externalTrafficPolicy修改为Cluster，但是在应用中会丢失源IP。</p>
<p> 参考<a href="https://help.aliyun.com/knowledge_detail/171437.html?spm=5176.smartservice_service_chat.0.0.7f95709asvYshC">https://help.aliyun.com/knowledge_detail/171437.html?spm=5176.smartservice_service_chat.0.0.7f95709asvYshC</a></p>
</blockquote>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>k8s</tag>
      </tags>
  </entry>
  <entry>
    <title>spring项目从启动到提供访问经过了哪些服务</title>
    <url>/2023/05/22/spring%E9%A1%B9%E7%9B%AE%E4%BB%8E%E5%90%AF%E5%8A%A8%E5%88%B0%E6%8F%90%E4%BE%9B%E8%AE%BF%E9%97%AE%E7%BB%8F%E8%BF%87%E4%BA%86%E5%93%AA%E4%BA%9B%E6%9C%8D%E5%8A%A1/</url>
    <content><![CDATA[<h2 id="dns"><a href="#dns" class="headerlink" title="dns"></a>dns</h2><p>  当一个用户在地址栏输入一个域名时，DNS解析过程如下：<span id="more"></span></p>
<ol>
<li>浏览器先检查自身缓存中有没有被解析过的这个域名对应的ip地址，如果有，解析结束。</li>
<li>如果浏览器缓存没有命中，检查操作系统中本地的hosts文件是否有这个网址映射关系，如果有，就先调用这个IP地址映射，完成域名解析。</li>
<li>如果还没有命中域名，才会真正的请求本地域名服务器（LDNS）来解析这个域名，这台服务器会缓存域名解析结果，大约80%的域名解析到这里就完成了。</li>
<li>如果LDNS仍然没有命中，就直接跳到Root Server 域名服务器迭代查询解析，直到获取到abc.com的dns服务器地址。</li>
<li>当本地DNS服务器收到这个地址后，就会找zjyjc.com域服务器，进行递归查询，直至找到<a href="http://www.abc.com主机./">www.abc.com主机。</a></li>
</ol>
<h2 id="cdn"><a href="#cdn" class="headerlink" title="cdn"></a>cdn</h2><p>  由分布在不同区域的边缘节点服务器群组成的分布式网络。</p>
<p>  阿里云DNS调度系统为用户分配cname的最佳节点IP地址：</p>
<ul>
<li>如果该IP地址对应的节点已缓存该资源，则会将数据直接返回给用户。</li>
<li>如果该IP地址对应的节点未缓存该资源，则节点向源站发起对该资源的请求。获取资源后，结合用户自定义配置的缓存策略，将资源缓存至节点。</li>
</ul>
<h2 id="waf-web应用防火墙"><a href="#waf-web应用防火墙" class="headerlink" title="waf(web应用防火墙)"></a>waf(web应用防火墙)</h2><p>  通过cname方式接入</p>
<p>  WAF可以有效识别Web业务流量的恶意特征，在对流量进行清洗和过滤后，将正常、安全的流量返回给服务器，避免网站服务器被恶意入侵导致服务器性能异常等问题，保障网站的业务安全和数据安全。</p>
<h2 id="slb-负载均衡"><a href="#slb-负载均衡" class="headerlink" title="slb(负载均衡)"></a>slb(负载均衡)</h2><p>   slb通过监听容器组的80,443端口，提供容器外部可访问的url。</p>
<h2 id="service"><a href="#service" class="headerlink" title="service"></a>service</h2><p>   service类型主要有ClusterIP、NodePort、LoadBalancer3种。</p>
<p>   service以标签的形式选定一组带有指定标签的 Pod，并监控和自动负载他们的 Pod IP，我们只需要通过 Service IP 访问就行了。</p>
<p>   Pod是Kubernetes创建或部署的最小&#x2F;最简单的基本单位，一个Pod代表集群上正在运行的一个进程。一个Pod封装一个应用容器（也可以有多个容器）。</p>
<h2 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h2><blockquote>
<p>server {<br>listen 80 default_server;<br>server_name <a href="http://www.abc.com/">www.abc.com</a>;<br>location ^~ &#x2F;api&#x2F;admin {<br>proxy_pass <a href="http://admin-api/">http://admin-api</a>;<br>}<br>location ^~ &#x2F;api&#x2F; {<br>proxy_pass <a href="http://gateway/">http://gateway</a>;<br>}<br>}<br>upstream gateway {<br>}<br>upstream admin-api {<br>}</p>
</blockquote>
<h2 id="gateway"><a href="#gateway" class="headerlink" title="gateway"></a>gateway</h2><p>  gateway服务中application.yml定义路由策略</p>
<blockquote>
<p>server:<br>port: 19340</p>
<p>spring:<br>cloud:<br>gateway:<br>routes:<br>- id: eauth<br>order: 10<br>uri: lb:&#x2F;&#x2F;sso-api<br>predicates:<br>- Path&#x3D;&#x2F;api&#x2F;auth&#x2F;**</p>
</blockquote>
<h2 id="8、spring项目"><a href="#8、spring项目" class="headerlink" title="8、spring项目"></a>8、spring项目</h2><p>  bootstrap.yml定义服务名及启动参数</p>
<blockquote>
<p>spring:<br>application:<br>name: sso-api<br>profiles:<br>active: local<br>cloud:<br>nacos:<br>discovery:<br>server-addr: ${NACOS_SERVER:}:${NACOS_PORT:8848}<br>namespace: ${NACOS_NAMESPACE:}<br>config:<br>server-addr: ${NACOS_SERVER:}:${NACOS_PORT:8848}<br>namespace: ${NACOS_NAMESPACE:}<br>file-extension: yml<br>shared-dataids: application-sso-${spring.profiles.active}.yml<br>refreshable-dataids: application-sso-${spring.profiles.active}.yml</p>
</blockquote>
<p>  gradle clean bootJar生成jar包，构建docker镜像，deployment中为容器设置预启动命令及参数<br>  通过3个环境变量在nacos服务中确定配置，完成注册</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">containers:</span><br><span class="line">  - args:</span><br><span class="line">          - &#x27;-jar&#x27;</span><br><span class="line">          - ./api.jar</span><br><span class="line">          - &#x27;-XX:+UseG1GC&#x27;</span><br><span class="line">          - &#x27;-XX:+HeapDumpOnOutOfMemoryError&#x27;</span><br><span class="line">          - &#x27;-Xms512M&#x27;</span><br><span class="line">          - &#x27;-Xmx4G&#x27;</span><br><span class="line">          - &#x27;--spring.profiles.active=prod&#x27;</span><br><span class="line">          - &#x27;--NACOS_SERVER=nacos-svc&#x27;</span><br><span class="line">          - &#x27;--NACOS_NAMESPACE=829cc240-d9&#x27;</span><br></pre></td></tr></table></figure>
</blockquote>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>wordpress配置cdn支持https</title>
    <url>/2023/05/22/wordpress%E9%85%8D%E7%BD%AEcdn%E6%94%AF%E6%8C%81https/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><ul>
<li>wordpress默认通过http访问，修改配置使支持https。<span id="more"></span></li>
</ul>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>1、进入WP后台，进入设置-常规 将WordPress地址（URL）、站点地址（URL）两项修改为：https。 或者更改数据库wp_option第1，2行http协议。</p>
<p>2、修改网站根目录下wp-config.php</p>
<p>在<code>\* @package WordPress</code>后面添加（不可在最后添加）：</p>
<blockquote>
<p>&#96;&#x2F;* 强制后台和登录使用 SSL *&#x2F;</p>
<p>$_SERVER[‘HTTPS’] &#x3D; ‘on’;</p>
<p>define(‘FORCE_SSL_LOGIN’, true);</p>
<p>define(‘FORCE_SSL_ADMIN’, true);</p>
</blockquote>
<p>3、修改&#x2F;wp-includes&#x2F;load.php中的function is_ssl()，将文件里$_SERVER[‘HTTPS’]全部修改为$_SERVER[“HTTP_FROM_HTTPS”]，将最后一行的return false 更改为return true</p>
<p>4、更改之前添加的多媒体文件地址，博客地址换为自己的域名</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">update wp_posts set post_content = replace(post_content, &#x27;http://博客地址&#x27;,&#x27;https://博客地址&#x27;)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>5、cdn配置https证书，开启https强制跳转。</p>
]]></content>
      <categories>
        <category>wordpress</category>
      </categories>
      <tags>
        <tag>wordpress</tag>
      </tags>
  </entry>
  <entry>
    <title>请求header过大springboot报400错误</title>
    <url>/2023/05/22/%E8%AF%B7%E6%B1%82header%E8%BF%87%E5%A4%A7springboot%E6%8A%A5400%E9%94%99%E8%AF%AF/</url>
    <content><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><ul>
<li>项目上线后所有后台接口报错400，接口直接访问正常，测试环境访问正常，经排查是由于正式环境请求cookie过大导致。<span id="more"></span></li>
</ul>
<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>1、nginx加大header缓存大小，未生效。</p>
<p>前端http {</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">client_header_buffer_size 64k; 默认值1k </span><br><span class="line">large_client_header_buffers 4 64k; 默认值4 8k</span><br></pre></td></tr></table></figure>

<p>}</p>
<p>2、后端springboot 配置后，问题解决，默认8KB</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server: </span><br><span class="line">  max-http-header-size: 64KB</span><br></pre></td></tr></table></figure>

<p>注：header限制需要所有经过的项目都放开限制</p>
]]></content>
      <categories>
        <category>springboot</category>
      </categories>
      <tags>
        <tag>nginx</tag>
        <tag>springboot</tag>
      </tags>
  </entry>
  <entry>
    <title>b站up视频数据抓取</title>
    <url>/2023/05/22/b%E7%AB%99up%E8%A7%86%E9%A2%91%E6%95%B0%E6%8D%AE%E6%8A%93%E5%8F%96/</url>
    <content><![CDATA[<h1 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h1><ul>
<li>通过upid获取所有视频封面、bv号、作者名，通过bv号抓取标题、播放、以及三连数据，存入excel。<span id="more"></span></li>
</ul>
<h1 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import requests</span><br><span class="line">import json</span><br><span class="line">import os</span><br><span class="line">from bs4 import BeautifulSoup</span><br><span class="line">from openpyxl import Workbook</span><br><span class="line">import re</span><br></pre></td></tr></table></figure>

<h1 id="文件下载"><a href="#文件下载" class="headerlink" title="文件下载"></a>文件下载</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def dl(f_name, url):</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    根据url下载文件并保存</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    rep = requests.get(url,timeout=3)</span><br><span class="line">    if rep.status_code == 200:</span><br><span class="line">        with open(f_name, &#x27;wb&#x27;) as f:</span><br><span class="line">            f.write(rep.content)</span><br></pre></td></tr></table></figure>

<h1 id="数据转换"><a href="#数据转换" class="headerlink" title="数据转换"></a>数据转换</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def get_realnum(str_num):</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    将40.2万播放类型的字符串转换为数字类型（low low low）。</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    num = list(filter(lambda x: x in &#x27;0123456789.&#x27;, str_num))</span><br><span class="line">    if num:</span><br><span class="line">        if &#x27;万&#x27; in str_num:</span><br><span class="line">            num = float(&#x27;&#x27;.join(num)) * 10000</span><br><span class="line">        else:</span><br><span class="line">            num = float(&#x27;&#x27;.join(num))</span><br><span class="line">    else:</span><br><span class="line">        num = 0</span><br><span class="line">    return int(num)</span><br></pre></td></tr></table></figure>

<h1 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def print_bv_lists_excel(bv_author,bv_lists):</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    将视频播放数据按up名字存入excel。</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    wb = Workbook()</span><br><span class="line">    wb.create_sheet(index=0,title=&#x27;播放数据&#x27;)</span><br><span class="line">    sheet=wb[&#x27;播放数据&#x27;]</span><br><span class="line">    sheet.append([&#x27;标题&#x27;,&#x27;播放&#x27;,&#x27;收藏&#x27;,&#x27;投币&#x27;,&#x27;点赞&#x27;,&#x27;BV号&#x27;])</span><br><span class="line">    for data in bv_lists:</span><br><span class="line">        sheet.append(data)</span><br><span class="line">    wb.save(bv_author+&#x27;.xlsx&#x27;)</span><br></pre></td></tr></table></figure>

<h1 id="封面下载"><a href="#封面下载" class="headerlink" title="封面下载"></a>封面下载</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def dl_img(allvideo):</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    下载up所有视频封面，按bv号存入以up名字命名的文件夹中。</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    for each in allvideo:</span><br><span class="line">        print(each[&#x27;pic&#x27;])</span><br><span class="line">        r_author=each[&#x27;author&#x27;]</span><br><span class="line">        r_name = r_author + &#x27;/&#x27; + each[&#x27;bvid&#x27;] + &#x27;.jpg&#x27;</span><br><span class="line">        if not os.path.exists(r_author):</span><br><span class="line">            os.mkdir(r_author)</span><br><span class="line">        dl(r_name,each[&#x27;pic&#x27;])</span><br></pre></td></tr></table></figure>

<h1 id="使用bs4解析bv数据"><a href="#使用bs4解析bv数据" class="headerlink" title="使用bs4解析bv数据"></a>使用bs4解析bv数据</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def get_bv_play_list(bvid):</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    获取当前bv号的标题、播放、以及三连数据。</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    url=&#x27;https://www.bilibili.com/video/&#x27; + bvid</span><br><span class="line">    bv_play_list = []</span><br><span class="line">    response=requests.get(url,timeout=3)</span><br><span class="line">    html=response.text</span><br><span class="line">    soup = BeautifulSoup(html, &#x27;lxml&#x27;)</span><br><span class="line">    h5_title = soup.select(&#x27;span[class^=&quot;tit&quot;]&#x27;)[0].get_text().strip()</span><br><span class="line">    h5_like = get_realnum(soup.select(&#x27;span[class=&quot;like&quot;]&#x27;)[0].get_text().strip())</span><br><span class="line">    h5_coin = get_realnum(soup.select(&#x27;span[class=&quot;coin&quot;]&#x27;)[0].get_text().strip())</span><br><span class="line">    h5_collect = get_realnum(soup.select(&#x27;span[class=&quot;collect&quot;]&#x27;)[0].get_text().strip())</span><br><span class="line">    h5_view = get_realnum(soup.select(&#x27;span[class=&quot;view&quot;]&#x27;)[0].get_text().strip())</span><br><span class="line">    bv_play_list.append((bvid,h5_title,h5_view,h5_collect,h5_coin,h5_like))</span><br><span class="line">    return bv_play_list</span><br></pre></td></tr></table></figure>

<h1 id="抓取up视频数据"><a href="#抓取up视频数据" class="headerlink" title="抓取up视频数据"></a>抓取up视频数据</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def get_vlist(upid=&#x27;2789978&#x27;):</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    获取当前upid的视频封面、bv号、作者，返回列表。</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    url=&#x27;https://api.bilibili.com/x/space/arc/search?mid=&#x27;+upid</span><br><span class="line">    response=requests.get(url,timeout=3)</span><br><span class="line">    data=json.loads(response.text)</span><br><span class="line">    allvideo=[]</span><br><span class="line">    if data[&#x27;code&#x27;] == 0:</span><br><span class="line">        r_pn=int(int(data[&#x27;data&#x27;][&#x27;page&#x27;][&#x27;count&#x27;])/50)+2</span><br><span class="line">        for pn in range(1,r_pn):</span><br><span class="line">            url=&#x27;https://api.bilibili.com/x/space/arc/search?ps=50&amp;pn=&#x27; + str(pn) + &#x27;&amp;mid=&#x27;+ upid</span><br><span class="line">            response = requests.get(url,timeout=3)</span><br><span class="line">            data = json.loads(response.text)</span><br><span class="line">            allvideo.extend(data[&#x27;data&#x27;][&#x27;list&#x27;][&#x27;vlist&#x27;])</span><br><span class="line">        return allvideo</span><br></pre></td></tr></table></figure>

<h1 id="表情包下载"><a href="#表情包下载" class="headerlink" title="表情包下载"></a>表情包下载</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def get_emote():</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    下载表情包</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">    url=&#x27;https://api.bilibili.com/x/emote/user/panel/web?business=reply&#x27;</span><br><span class="line">    response=requests.get(url,timeout=3)</span><br><span class="line">    data=json.loads(response.text)</span><br><span class="line">    lists=data[&#x27;data&#x27;][&#x27;packages&#x27;]</span><br><span class="line">    emote_dir=&#x27;emote&#x27;</span><br><span class="line">    if not os.path.exists(emote_dir):</span><br><span class="line">        os.mkdir(emote_dir)</span><br><span class="line">    for i in lists:</span><br><span class="line">        for emote in i[&#x27;emote&#x27;]:</span><br><span class="line">            pattern=r&#x27;^http&#x27;</span><br><span class="line">            match=re.match(pattern,emote[&#x27;url&#x27;])</span><br><span class="line">            if match != None:</span><br><span class="line">                name = emote_dir + &#x27;/&#x27; +  emote[&#x27;text&#x27;] + &#x27;.jpg&#x27;</span><br><span class="line">                dl(name,emote[&#x27;url&#x27;])</span><br></pre></td></tr></table></figure>

<h1 id="main"><a href="#main" class="headerlink" title="main"></a>main</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    upid = input(&#x27;请输入B站up主id：&#x27;)</span><br><span class="line">    allvideo=get_vlist(upid)</span><br><span class="line">    a=get_bv_play_list(&#x27;BV1v3411z7k5&#x27;)</span><br><span class="line">    print(a)</span><br><span class="line">    dl_img(allvideo)</span><br><span class="line">    bv_play_lists=[]</span><br><span class="line">    for each in allvideo: #获取每个视频播放数据</span><br><span class="line">        print(each[&#x27;bvid&#x27;])</span><br><span class="line">        bv_play_list=get_bv_play_list(each[&#x27;bvid&#x27;])</span><br><span class="line">        bv_play_lists.extend(bv_play_list)</span><br><span class="line">    bv_play_lists.sort(key=lambda x:(x[2],x[3],x[4],x[5]),reverse=True) #根据播放量、收藏、投币、点赞排序</span><br><span class="line">    bv_author = allvideo[0][&#x27;author&#x27;]  # 获取视频作者</span><br><span class="line">    print_bv_lists_excel(bv_author,bv_play_lists)</span><br><span class="line">    emote=get_emote() #下载通用表情包</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>elasticsearch通过logstash同步mysql</title>
    <url>/2023/05/22/elasticsearch%E9%80%9A%E8%BF%87logstash%E5%90%8C%E6%AD%A5mysql/</url>
    <content><![CDATA[<blockquote>
<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul>
<li>elasticsearch版本：<code>7.4</code></li>
<li>logstash版本：<code>7.4</code></li>
<li>mysql版本：<code>8.0</code><span id="more"></span></li>
</ul>
<h1 id="logstash配置文件"><a href="#logstash配置文件" class="headerlink" title="logstash配置文件"></a>logstash配置文件</h1> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  jdbc &#123;</span><br><span class="line">    jdbc_driver_class =&gt; &quot;com.mysql.jdbc.Driver&quot;</span><br><span class="line">    jdbc_driver_library =&gt; &quot;/ssd/1/share/ls-cn-***/logstash/current/config/custom/mysql-connector-java-8.0.18.jar&quot;</span><br><span class="line">    jdbc_connection_string =&gt; &quot;jdbc:mysql://***:3306/数据库名?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;allowLoadLocalInfile=false&amp;autoDeserialize=false&quot;</span><br><span class="line">    jdbc_user =&gt; &quot;&quot;</span><br><span class="line">    jdbc_password =&gt; &quot;&quot;</span><br><span class="line">    #sql是否允许分页</span><br><span class="line">    jdbc_paging_enabled =&gt; &quot;true&quot;</span><br><span class="line">    jdbc_page_size =&gt; &quot;100000&quot;</span><br><span class="line">    #查询sql，通过update_time实现增量更新，order排序确保更新时间为最新时间</span><br><span class="line">    statement =&gt; &quot;select `a`.`id` AS `id` where `a`.`update_time`&gt;= :sql_last_value order by update_time ASC&quot;</span><br><span class="line">    schedule =&gt; &quot; */5 * * * * *&quot;</span><br><span class="line">    record_last_run =&gt; true</span><br><span class="line">    last_run_metadata_path =&gt; &quot;/ssd/1/ls-cn-zz11yyn8e00a/logstash/data/last_run_metadata_test_resource_company_update_time0107.txt&quot;</span><br><span class="line">    clean_run =&gt; false</span><br><span class="line">    #分数字类型和时间戳类型，默认数字，无更新操作可以使用主键做增量更新</span><br><span class="line">    tracking_column_type =&gt; &quot;timestamp&quot;</span><br><span class="line">    use_column_value =&gt; true</span><br><span class="line">    tracking_column =&gt; &quot;update_time&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">#更新es时间存储格式为datetime类型，es创建索引需要增加format支持datetime格式</span><br><span class="line">#      &quot;create_time&quot;: &#123;</span><br><span class="line">#       &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">#       &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd&quot;&#125;</span><br><span class="line">  ruby&#123;</span><br><span class="line">      code =&gt; &quot;</span><br><span class="line">      event.set(&#x27;create_time&#x27;, (event.get(&#x27;create_time&#x27;).time.localtime).strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;))</span><br><span class="line">      event.set(&#x27;review_time&#x27;, (event.get(&#x27;review_time&#x27;).time.localtime).strftime(&#x27;%Y-%m-%d %H:%M:%S&#x27;))</span><br><span class="line">      &quot;</span><br><span class="line">      &#125;</span><br><span class="line">  date &#123;    </span><br><span class="line">        match =&gt; [&quot;create_time&quot;, &quot;yyyy-MM-dd HH:mm:ss&quot;]   </span><br><span class="line">  &#125;</span><br><span class="line">  date &#123;    </span><br><span class="line">        match =&gt; [&quot;review_time&quot;, &quot;yyyy-MM-dd HH:mm:ss&quot;]   </span><br><span class="line">  &#125;</span><br><span class="line">  mutate &#123;</span><br><span class="line">    remove_field =&gt; [&quot;@timestamp&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line"> elasticsearch &#123;</span><br><span class="line">    hosts =&gt; &quot;http://*****:9200&quot;</span><br><span class="line">    index =&gt; &quot;es_index&quot;</span><br><span class="line">    user =&gt; &quot;elastic&quot;</span><br><span class="line">    password =&gt; &quot;****&quot;</span><br><span class="line">    document_id =&gt; &quot;%&#123;id&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="devtools常用接口"><a href="#devtools常用接口" class="headerlink" title="devtools常用接口"></a>devtools常用接口</h1><blockquote>
<p>#修改索引最大查询数</p>
<p>PUT es_index&#x2F;_settings<br>{<br>“index”:{<br>“max_result_window”:1000000<br>}<br>}</p>
<p>#定义索引别名</p>
<p>POST &#x2F;_aliases<br>{<br>“actions”: [<br>{<br>“add”: {<br>“index”: “es_index0114”,<br>“alias”: “es_index”<br>}<br>}<br>]<br>}</p>
<p>#es使用sql语法</p>
<p>POST &#x2F;_sql<br>{<br>“query”: “select * from es_index where id &#x3D; ‘26427’”<br>}</p>
</blockquote>
<h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ul>
<li>logstash支持mysql视图查询，但数据过多时查询很慢，iops压力会很大，建议使用查询语句查询</li>
<li>logstash支持秒级查询，格式同crontab</li>
<li>mysql默认时间0000-00-00,非有效日期,logstash无法同步</li>
</ul>
</blockquote>
]]></content>
      <categories>
        <category>ES</category>
      </categories>
      <tags>
        <tag>ES</tag>
      </tags>
  </entry>
</search>
