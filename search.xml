<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>openvpn搭建</title>
    <url>/2020/12/01/openvpn%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul>
<li>此法用于客户端通过OpenVPN服务器访问服务器所在私网网段<a id="more"></a></li>
<li>OpenVPN服务器操作系统<code>centos7.8</code></li>
<li>OpenVPN版本<code>2.4.9</code></li>
<li>easy-rsa版本<code>3.0.8</code></li>
<li>使用<code>tun</code>模式</li>
<li>客户端IP地址池<code>10.8.0.0/24</code></li>
<li>多个客户端直接可以通过OpenVPN实现通信</li>
</ul>
<h1 id="准备操作"><a href="#准备操作" class="headerlink" title="准备操作"></a>准备操作</h1><h2 id="添加EPEL源"><a href="#添加EPEL源" class="headerlink" title="添加EPEL源"></a>添加EPEL源</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install epel-release -y</span><br></pre></td></tr></table></figure>

<h2 id="替换为阿里云的源"><a href="#替换为阿里云的源" class="headerlink" title="替换为阿里云的源"></a>替换为阿里云的源</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sed -e &#39;s,^#baseurl,baseurl,g&#39; \</span><br><span class="line">    -e &#39;s,^metalink,#metalink,g&#39; \</span><br><span class="line">    -e &#39;s,^mirrorlist&#x3D;,#mirrorlist&#x3D;,g&#39; \</span><br><span class="line">    -e &#39;s,http:&#x2F;&#x2F;download.fedoraproject.org&#x2F;pub,https:&#x2F;&#x2F;mirrors.aliyun.com,g&#39; \</span><br><span class="line">    -i &#x2F;etc&#x2F;yum.repos.d&#x2F;epel.repo</span><br></pre></td></tr></table></figure>

<h2 id="更新软件"><a href="#更新软件" class="headerlink" title="更新软件"></a>更新软件</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum makecache</span><br><span class="line">yum update -y</span><br></pre></td></tr></table></figure>

<h2 id="修改sysctl参数"><a href="#修改sysctl参数" class="headerlink" title="修改sysctl参数"></a>修改sysctl参数</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo &quot;net.ipv4.ip_forward &#x3D; 1&quot; &gt;&gt;&#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<h2 id="安装OpenVPN软件"><a href="#安装OpenVPN软件" class="headerlink" title="安装OpenVPN软件"></a>安装OpenVPN软件</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y openvpn easy-rsa lrzsz iptables-services</span><br></pre></td></tr></table></figure>

<h1 id="配置服务器证书"><a href="#配置服务器证书" class="headerlink" title="配置服务器证书"></a>配置服务器证书</h1><h2 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h2><blockquote>
<p>拷贝easy-rsa的文件到/etc/openvpn下</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cp -r &#x2F;usr&#x2F;share&#x2F;easy-rsa&#x2F;3.0.8 &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa</span><br><span class="line">cp &#x2F;usr&#x2F;share&#x2F;doc&#x2F;easy-rsa-3.0.8&#x2F;vars.example &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;vars</span><br></pre></td></tr></table></figure>

<h2 id="修改vars"><a href="#修改vars" class="headerlink" title="修改vars"></a>修改vars</h2><blockquote>
<p>编辑vars文件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;vars</span><br></pre></td></tr></table></figure>

<blockquote>
<p>修改以下几项</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#set_var EASYRSA_REQ_COUNTRY     &quot;US&quot;</span><br><span class="line">#set_var EASYRSA_REQ_PROVINCE    &quot;California&quot;</span><br><span class="line">#set_var EASYRSA_REQ_CITY        &quot;San Francisco&quot;</span><br><span class="line">#set_var EASYRSA_REQ_ORG         &quot;Copyleft Certificate Co&quot;</span><br><span class="line">#set_var EASYRSA_REQ_EMAIL       &quot;me@example.net&quot;</span><br><span class="line">#set_var EASYRSA_REQ_OU          &quot;My Organizational Unit&quot;</span><br><span class="line">#set_var EASYRSA_KEY_SIZE        4096</span><br><span class="line">#set_var EASYRSA_ALGO            rsa</span><br><span class="line">#set_var EASYRSA_CA_EXPIRE       3650</span><br><span class="line">#set_var EASYRSA_CERT_EXPIRE     3650</span><br><span class="line">#set_var EASYRSA_CERT_RENEW      180</span><br><span class="line">#set_var EASYRSA_CRL_DAYS        60</span><br></pre></td></tr></table></figure>

<h2 id="初始化PKI和CA"><a href="#初始化PKI和CA" class="headerlink" title="初始化PKI和CA"></a>初始化PKI和CA</h2><h3 id="切换目录"><a href="#切换目录" class="headerlink" title="切换目录"></a>切换目录</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa</span><br></pre></td></tr></table></figure>

<h3 id="创建PKI"><a href="#创建PKI" class="headerlink" title="创建PKI"></a>创建PKI</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;easyrsa init-pki</span><br></pre></td></tr></table></figure>

<h3 id="创建CA"><a href="#创建CA" class="headerlink" title="创建CA"></a>创建CA</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;easyrsa build-ca nopass</span><br></pre></td></tr></table></figure>

<h2 id="创建服务器证书"><a href="#创建服务器证书" class="headerlink" title="创建服务器证书"></a>创建服务器证书</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;easyrsa build-server-full openvpn-server nopass</span><br></pre></td></tr></table></figure>

<h2 id="创建DH证书"><a href="#创建DH证书" class="headerlink" title="创建DH证书"></a>创建DH证书</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;easyrsa gen-dh</span><br></pre></td></tr></table></figure>

<h2 id="拷贝证书"><a href="#拷贝证书" class="headerlink" title="拷贝证书"></a>拷贝证书</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir -p &#x2F;etc&#x2F;openvpn&#x2F;pki</span><br><span class="line">cp &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;pki&#x2F;ca.crt \</span><br><span class="line">   &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;pki&#x2F;dh.pem \</span><br><span class="line">   &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;pki&#x2F;issued&#x2F;openvpn-server.crt \</span><br><span class="line">   &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;pki&#x2F;private&#x2F;openvpn-server.key \</span><br><span class="line">   &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;</span><br><span class="line">ln -sv &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;pki&#x2F;crl.pem &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;crl.pem</span><br><span class="line">chown -R root:openvpn &#x2F;etc&#x2F;openvpn&#x2F;pki</span><br></pre></td></tr></table></figure>

<h2 id="创建ta-key"><a href="#创建ta-key" class="headerlink" title="创建ta.key"></a>创建ta.key</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">openvpn --genkey --secret &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;ta.key</span><br></pre></td></tr></table></figure>

<h1 id="配置OpenVPN"><a href="#配置OpenVPN" class="headerlink" title="配置OpenVPN"></a>配置OpenVPN</h1><h2 id="创建日志目录"><a href="#创建日志目录" class="headerlink" title="创建日志目录"></a>创建日志目录</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir -p &#x2F;var&#x2F;log&#x2F;openvpn</span><br><span class="line">chown -R openvpn:openvpn &#x2F;var&#x2F;log&#x2F;openvpn</span><br></pre></td></tr></table></figure>

<h2 id="创建客户端配置目录"><a href="#创建客户端配置目录" class="headerlink" title="创建客户端配置目录"></a>创建客户端配置目录</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir -p &#x2F;etc&#x2F;openvpn&#x2F;client&#x2F;&#123;config,user&#125;</span><br><span class="line">chown -R root:openvpn &#x2F;etc&#x2F;openvpn&#x2F;client&#x2F;&#123;config,user&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置OpenVPN服务器端"><a href="#配置OpenVPN服务器端" class="headerlink" title="配置OpenVPN服务器端"></a>配置OpenVPN服务器端</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;openvpn&#x2F;server&#x2F;srv.conf</span><br></pre></td></tr></table></figure>

<blockquote>
<p>下面内容按需更改</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 监听地址</span><br><span class="line">local 0.0.0.0</span><br><span class="line"># 监听端口</span><br><span class="line">port 51194</span><br><span class="line"># 通信协议</span><br><span class="line">proto tcp</span><br><span class="line"># TUN模式还是TAP模式</span><br><span class="line">dev tun</span><br><span class="line"># 证书</span><br><span class="line">ca         &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;ca.crt</span><br><span class="line">cert       &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;openvpn-server.crt</span><br><span class="line">key        &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;openvpn-server.key</span><br><span class="line">dh         &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;dh.pem</span><br><span class="line">crl-verify &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;crl.pem</span><br><span class="line"># 禁用OpenVPN自定义缓冲区大小，由操作系统控制</span><br><span class="line">sndbuf 0</span><br><span class="line">rcvbuf 0</span><br><span class="line"># TLS rules “client” | “server”</span><br><span class="line">remote-cert-tls  &quot;client&quot;</span><br><span class="line"># TLS认证</span><br><span class="line">tls-auth &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;ta.key</span><br><span class="line"># TLS最小版本</span><br><span class="line">#tls-version-min &quot;1.2&quot;</span><br><span class="line"># 重新协商数据交换的key，默认3600</span><br><span class="line">#reneg-sec 3600</span><br><span class="line"># 在此文件中维护客户端与虚拟IP地址之间的关联记录</span><br><span class="line"># 如果OpenVPN重启，重新连接的客户端可以被分配到先前分配的虚拟IP地址</span><br><span class="line">ifconfig-pool-persist &#x2F;etc&#x2F;openvpn&#x2F;ipp.txt</span><br><span class="line"># 配置client配置文件</span><br><span class="line">client-config-dir &#x2F;etc&#x2F;openvpn&#x2F;client&#x2F;config</span><br><span class="line"># 该网段为 open VPN 虚拟网卡网段，不要和内网网段冲突即可。</span><br><span class="line">server 10.8.0.0 255.255.255.0</span><br><span class="line"># 给客户端推送自定义路由</span><br><span class="line">#push &quot;route 192.168.0.0 255.255.255.0&quot;</span><br><span class="line"># 所有客户端的默认网关都将重定向到VPN</span><br><span class="line">#push &quot;redirect-gateway def1 bypass-dhcp&quot;  </span><br><span class="line"># 向客户端推送DNS配置</span><br><span class="line">#push &quot;dhcp-option DNS 223.5.5.5&quot;</span><br><span class="line">#push &quot;dhcp-option DNS 223.6.6.6&quot;</span><br><span class="line"># 允许客户端之间互相访问</span><br><span class="line">client-to-client</span><br><span class="line"># 限制最大客户端数量</span><br><span class="line">#max-clients 10</span><br><span class="line"># 客户端连接时运行脚本</span><br><span class="line">#client-connect ovpns.script</span><br><span class="line"># 客户端断开连接时运行脚本</span><br><span class="line">#client-disconnect ovpns.script</span><br><span class="line"># 保持连接时间</span><br><span class="line">keepalive 20 120</span><br><span class="line"># 开启vpn压缩</span><br><span class="line">comp-lzo</span><br><span class="line"># 允许多人使用同一个证书连接VPN，不建议使用，注释状态</span><br><span class="line">#duplicate-cn</span><br><span class="line"># 运行用户</span><br><span class="line">user openvpn</span><br><span class="line">#运行组</span><br><span class="line">group openvpn</span><br><span class="line"># 持久化选项可以尽量避免访问那些在重启之后由于用户权限降低而无法访问的某些资源</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line"># 显示当前的连接状态</span><br><span class="line">status      &#x2F;var&#x2F;log&#x2F;openvpn&#x2F;openvpn-status.log</span><br><span class="line"># 日志路径，不指定文件路径时输出到控制台</span><br><span class="line"># log代表每次启动时清空日志文件</span><br><span class="line">#log        &#x2F;var&#x2F;log&#x2F;openvpn&#x2F;openvpn.log</span><br><span class="line"># log-append代表追加写入到日志文件</span><br><span class="line">#log-append  &#x2F;var&#x2F;log&#x2F;openvpn&#x2F;openvpn.log</span><br><span class="line"># 日志级别</span><br><span class="line">verb 4</span><br><span class="line"># 忽略过多的重复信息，相同类别的信息只有前20条会输出到日志文件中</span><br><span class="line">mute 20</span><br></pre></td></tr></table></figure>

<h2 id="启动OpenVPN-server"><a href="#启动OpenVPN-server" class="headerlink" title="启动OpenVPN-server"></a>启动OpenVPN-server</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chown -R root:openvpn &#x2F;etc&#x2F;openvpn</span><br><span class="line">systemctl enable openvpn-server@srv.service</span><br><span class="line">systemctl start openvpn-server@srv.service</span><br></pre></td></tr></table></figure>

<h2 id="开启iptables策略"><a href="#开启iptables策略" class="headerlink" title="开启iptables策略"></a>开启iptables策略</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 10.8.0.0&#x2F;24 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<h2 id="定期更新CRL"><a href="#定期更新CRL" class="headerlink" title="定期更新CRL"></a>定期更新CRL</h2><h3 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h3><ul>
<li>OpenVPN的server配置里面添加了<code>crl-verify</code>之后，需要给crl定期更新</li>
<li>如果crl文件长期不更新，过期之后，OpenVPN会报无法验证证书，导致无法连接OpenVPN</li>
</ul>
<h3 id="配置systemd-timer"><a href="#配置systemd-timer" class="headerlink" title="配置systemd timer"></a>配置systemd timer</h3><h3 id="定义Service"><a href="#定义Service" class="headerlink" title="定义Service"></a>定义Service</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;easyrsa-gen-crl.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;easyrsa-gen-crl</span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;oneshot</span><br><span class="line"># 重新生成CRL文件</span><br><span class="line">ExecStart&#x3D;&#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;easyrsa gen-crl</span><br><span class="line"># 命令完成之后重启OpenVPN服务</span><br><span class="line">ExecStartPost&#x3D;&#x2F;usr&#x2F;bin&#x2F;systemctl restart openvpn-server@srv.service</span><br><span class="line">WorkingDirectory&#x3D;&#x2F;etc&#x2F;openvpn&#x2F;easy-rsa</span><br></pre></td></tr></table></figure>

<h3 id="定义timer"><a href="#定义timer" class="headerlink" title="定义timer"></a>定义timer</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;easyrsa-gen-crl.timer</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;easyrsa-gen-crl</span><br><span class="line"></span><br><span class="line">[Timer]</span><br><span class="line"># 每周一凌晨4点触发easyrsa-gen-crl.service</span><br><span class="line">OnCalendar&#x3D;Mon *-*-* 04:00:00</span><br><span class="line">Persistent&#x3D;true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;timers.target</span><br></pre></td></tr></table></figure>

<h3 id="启动timer"><a href="#启动timer" class="headerlink" title="启动timer"></a>启动timer</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl enable easyrsa-gen-crl.timer</span><br><span class="line">systemctl start easyrsa-gen-crl.timer</span><br></pre></td></tr></table></figure>

<h3 id="立刻启动service"><a href="#立刻启动service" class="headerlink" title="立刻启动service"></a>立刻启动service</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start easy-rsa-gen-crl.service</span><br></pre></td></tr></table></figure>

<h3 id="查看Service日志"><a href="#查看Service日志" class="headerlink" title="查看Service日志"></a>查看Service日志</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">journalctl -xfu easy-rsa-gen-crl.service</span><br></pre></td></tr></table></figure>

<h3 id="查看timer状态"><a href="#查看timer状态" class="headerlink" title="查看timer状态"></a>查看timer状态</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl status easyrsa-gen-crl.timer</span><br></pre></td></tr></table></figure>

<h1 id="客户端管理"><a href="#客户端管理" class="headerlink" title="客户端管理"></a>客户端管理</h1><h2 id="客户端配置模板"><a href="#客户端配置模板" class="headerlink" title="客户端配置模板"></a>客户端配置模板</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;openvpn&#x2F;templates&#x2F;ovpn.template</span><br><span class="line"># 配置为客户端模式</span><br><span class="line">client</span><br><span class="line"># 与服务器端保持一致</span><br><span class="line">proto tcp</span><br><span class="line"># 与服务器端保持一致</span><br><span class="line">dev tun</span><br><span class="line"># 配置服务器端的地址和端口</span><br><span class="line">remote 服务端ip 51194</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">comp-lzo</span><br><span class="line">nice 0</span><br><span class="line">verb 3</span><br><span class="line">mute 10</span><br><span class="line"># 禁用OpenVPN自定义缓冲区大小，由操作系统控制</span><br><span class="line">sndbuf 0</span><br><span class="line">rcvbuf 0</span><br><span class="line"># 禁止在内存中缓存password</span><br><span class="line">auth-nocache</span><br><span class="line"># TLS rules “client” | “server”</span><br><span class="line">remote-cert-tls server</span><br><span class="line"># 过滤从服务器端发过来的路由规则</span><br><span class="line">#pull-filter ignore redirect-gateway</span><br><span class="line"># 不从服务器端拉取路由规则</span><br><span class="line">#route-nopull</span><br><span class="line"># 手动指定所有流量走VPN</span><br><span class="line">#redirect-gateway def1</span><br><span class="line"># 客户端自定义路由，例如192.168.0.0&#x2F;24走VPN，192.168.1.0&#x2F;24不走VPN</span><br><span class="line">#route 192.168.0.0 255.255.255.0 vpn_gateway</span><br><span class="line">#route 192.168.1.0 255.255.255.0 net_gateway</span><br></pre></td></tr></table></figure>

<h2 id="指定客户端推送配置"><a href="#指定客户端推送配置" class="headerlink" title="指定客户端推送配置"></a>指定客户端推送配置</h2><h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;openvpn&#x2F;templates&#x2F;ipconfig_push.template</span><br><span class="line"># 给客户端推送固定的IP地址</span><br><span class="line">ifconfig-push #ipaddress# 255.255.255.0</span><br><span class="line"># 给客户端推送路由</span><br><span class="line">#iroute 172.17.0.0 255.255.0.0</span><br></pre></td></tr></table></figure>

<h3 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;openvpn&#x2F;client&#x2F;config&#x2F;user1</span><br><span class="line"># 给客户端推送固定的IP地址10.8.0.100</span><br><span class="line">ifconfig-push 10.8.0.100 255.255.255.0</span><br></pre></td></tr></table></figure>

<h2 id="用户管理脚本"><a href="#用户管理脚本" class="headerlink" title="用户管理脚本"></a>用户管理脚本</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;usr&#x2F;local&#x2F;bin&#x2F;ovpn_mgmt.sh</span><br><span class="line">chmod +x &#x2F;usr&#x2F;local&#x2F;bin&#x2F;ovpn_mgmt.sh</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line"># 定义环境变量</span><br><span class="line">export EASY_RSA_DIR&#x3D;&quot;&#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&quot;</span><br><span class="line">export CLIENT_CONFIG_DIR&#x3D;&quot;&#x2F;etc&#x2F;openvpn&#x2F;client&#x2F;config&quot;</span><br><span class="line">export PKI_DIR&#x3D;&quot;$&#123;EASY_RSA_DIR&#125;&#x2F;pki&quot;</span><br><span class="line">export TEMPLATES_DIR&#x3D;&quot;&#x2F;etc&#x2F;openvpn&#x2F;templates&quot;</span><br><span class="line">export CLIENT_USER_DIR&#x3D;&quot;&#x2F;etc&#x2F;openvpn&#x2F;client&#x2F;user&quot;</span><br><span class="line"></span><br><span class="line"># 创建ovpn配置</span><br><span class="line">generate_ovpn() &#123;</span><br><span class="line">	USER_OVPN&#x3D;&quot;$&#123;CLIENT_USER_DIR&#125;&#x2F;$&#123;EXPIRED&#125;-$&#123;USER&#125;.ovpn&quot;</span><br><span class="line">	# 根据证书生成对应的ovpn文件</span><br><span class="line">    mkdir -p  $&#123;CLIENT_USER_DIR&#125;&#x2F;</span><br><span class="line">    cp -f $&#123;TEMPLATES_DIR&#125;&#x2F;ovpn.template $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;ca&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat $&#123;PKI_DIR&#125;&#x2F;ca.crt &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;&#x2F;ca&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;cert&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat $&#123;PKI_DIR&#125;&#x2F;issued&#x2F;$&#123;USER&#125;.crt &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;&#x2F;cert&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;key&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat $&#123;PKI_DIR&#125;&#x2F;private&#x2F;$&#123;USER&#125;.key &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;&#x2F;key&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;tls-auth&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;ta.key &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;&#x2F;tls-auth&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    sz --binary $&#123;USER_OVPN&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 添加客户端IP</span><br><span class="line">client_ip_config() &#123;</span><br><span class="line">	# 根据ip地址生成对应的client-config</span><br><span class="line">    sed -e &quot;s,#ipaddress#,$&#123;IPADDRESS&#125;,g&quot; \</span><br><span class="line">        $&#123;TEMPLATES_DIR&#125;&#x2F;ipconfig_push.template \</span><br><span class="line">        &gt; $&#123;CLIENT_CONFIG_DIR&#125;&#x2F;$&#123;USER&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 生成客户端证书</span><br><span class="line">add_cert() &#123;</span><br><span class="line">	# 切换到easy-rsa目录</span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    $&#123;EASY_RSA_DIR&#125;&#x2F;easyrsa build-client-full $&#123;USER&#125; nopass</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 注销客户端证书</span><br><span class="line">revoke_cert() &#123;</span><br><span class="line">	# 切换到easy-rsa目录</span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    echo &quot;yes&quot; | $&#123;EASY_RSA_DIR&#125;&#x2F;easyrsa revoke $&#123;USER&#125;</span><br><span class="line">	$&#123;EASY_RSA_DIR&#125;&#x2F;easyrsa gen-crl</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 更新客户端证书</span><br><span class="line">renew_cert() &#123;</span><br><span class="line">	# 切换到easy-rsa目录</span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    echo &quot;yes&quot; | $&#123;EASY_RSA_DIR&#125;&#x2F;easyrsa renew $&#123;USER&#125; nopass</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 检查证书过期时间</span><br><span class="line">check_cert_expired() &#123;</span><br><span class="line">	export EXPIRED&#x3D;$(date --date&#x3D;&quot;$(openssl x509 -enddate -noout -in $&#123;PKI_DIR&#125;&#x2F;issued&#x2F;$&#123;USER&#125;.crt |cut -d&#x3D; -f 2)&quot; --iso-8601)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 创建用户</span><br><span class="line">add_user() &#123;</span><br><span class="line">	if [[ -e &quot;$&#123;EASY_RSA_DIR&#125;&#x2F;pki&#x2F;reqs&#x2F;$&#123;USER&#125;.req&quot; ]];then</span><br><span class="line">		read -p&quot;此用户已经申请证书，是否重新生成？[y&#x2F;n]：&quot; ANSWER</span><br><span class="line">		case $&#123;ANSWER&#125; in</span><br><span class="line">		    y|Y)</span><br><span class="line">		        revoke_cert</span><br><span class="line">		        check_cert_expired</span><br><span class="line">		        client_ip_config</span><br><span class="line">		        add_cert</span><br><span class="line">		        generate_ovpn</span><br><span class="line">		        exit 0</span><br><span class="line">		        ;;</span><br><span class="line">			n|N)</span><br><span class="line">				check_cert_expired</span><br><span class="line">				client_ip_config</span><br><span class="line">				generate_ovpn</span><br><span class="line">				;;</span><br><span class="line">		esac</span><br><span class="line">	else</span><br><span class="line">		add_cert</span><br><span class="line">		check_cert_expired</span><br><span class="line">		client_ip_config</span><br><span class="line">		generate_ovpn</span><br><span class="line">	fi</span><br><span class="line">&#125;</span><br><span class="line"># 删除用户</span><br><span class="line">del_user() &#123;</span><br><span class="line">	revoke_cert</span><br><span class="line">	rm -rf $&#123;CLIENT_USER_DIR&#125;&#x2F;*$&#123;USER&#125;.ovpn</span><br><span class="line">	rm -rf $&#123;CLIENT_CONFIG_DIR&#125;&#x2F;$&#123;USER&#125;</span><br><span class="line">&#125;</span><br><span class="line"># 用户旧证过期重新生成证书</span><br><span class="line">renew_user() &#123;</span><br><span class="line">	if [[ -e &quot;$&#123;EASY_RSA_DIR&#125;&#x2F;pki&#x2F;reqs&#x2F;$&#123;USER&#125;.req&quot; ]];then</span><br><span class="line">        renew_cert</span><br><span class="line">        check_cert_expired</span><br><span class="line">        generate_ovpn</span><br><span class="line">    else</span><br><span class="line">    	echo &quot;用户证书不存在！&quot;</span><br><span class="line">    	exit 1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">    # 切换到easy-rsa目录</span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    # 根据传入的method运行对应函数</span><br><span class="line">    $&#123;METHOD&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 获取参数</span><br><span class="line">while getopts &#39;m:u:i:r&#39; OPT;do</span><br><span class="line">    case $OPT in</span><br><span class="line">        u)</span><br><span class="line">            USER&#x3D;&quot;$OPTARG&quot;</span><br><span class="line">            echo &quot;USER&#x3D;$&#123;USER&#125;&quot;</span><br><span class="line">            ;;</span><br><span class="line">        i)</span><br><span class="line">            IPADDRESS&#x3D;&quot;$OPTARG&quot;</span><br><span class="line">            echo &quot;IPADDRESS&#x3D;$&#123;IPADDRESS&#125;&quot;</span><br><span class="line">            ;;</span><br><span class="line">        m)</span><br><span class="line">            METHOD&#x3D;&quot;$OPTARG&quot;</span><br><span class="line">            echo &quot;METHOD&#x3D;$&#123;METHOD&#125;&quot;</span><br><span class="line">            ;;</span><br><span class="line">        ?)</span><br><span class="line">            echo &quot;Usage: $(base \&quot;$0\&quot;) -m [add_user|del_user|renew_user] -u USER -i IPADDRESS&quot;</span><br><span class="line">            exit 0</span><br><span class="line">            ;;</span><br><span class="line">    esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">main</span><br></pre></td></tr></table></figure>

<h2 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;ovpn_mgmt.sh -m add_user -u USERNAME -i 10.8.0.10</span><br></pre></td></tr></table></figure>

<h2 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a>删除用户</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;ovpn_mgmt.sh -m del_user -u USERNAME</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>centos</category>
      </categories>
      <tags>
        <tag>centos</tag>
      </tags>
  </entry>
</search>
