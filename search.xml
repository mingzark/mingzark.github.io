<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>openvpn搭建</title>
    <url>/2020/12/01/openvpn%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul>
<li>此法用于客户端通过OpenVPN服务器访问服务器所在私网网段<a id="more"></a></li>
<li>OpenVPN服务器操作系统<code>centos7.8</code></li>
<li>OpenVPN版本<code>2.4.9</code></li>
<li>easy-rsa版本<code>3.0.8</code></li>
<li>使用<code>tun</code>模式</li>
<li>客户端IP地址池<code>10.8.0.0/24</code></li>
<li>多个客户端直接可以通过OpenVPN实现通信</li>
</ul>
<h1 id="准备操作"><a href="#准备操作" class="headerlink" title="准备操作"></a>准备操作</h1><h2 id="添加EPEL源"><a href="#添加EPEL源" class="headerlink" title="添加EPEL源"></a>添加EPEL源</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install epel-release -y</span><br></pre></td></tr></table></figure>

<h2 id="替换为阿里云的源"><a href="#替换为阿里云的源" class="headerlink" title="替换为阿里云的源"></a>替换为阿里云的源</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sed -e &#39;s,^#baseurl,baseurl,g&#39; \</span><br><span class="line">    -e &#39;s,^metalink,#metalink,g&#39; \</span><br><span class="line">    -e &#39;s,^mirrorlist&#x3D;,#mirrorlist&#x3D;,g&#39; \</span><br><span class="line">    -e &#39;s,http:&#x2F;&#x2F;download.fedoraproject.org&#x2F;pub,https:&#x2F;&#x2F;mirrors.aliyun.com,g&#39; \</span><br><span class="line">    -i &#x2F;etc&#x2F;yum.repos.d&#x2F;epel.repo</span><br></pre></td></tr></table></figure>

<h2 id="更新软件"><a href="#更新软件" class="headerlink" title="更新软件"></a>更新软件</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum makecache</span><br><span class="line">yum update -y</span><br></pre></td></tr></table></figure>

<h2 id="修改sysctl参数"><a href="#修改sysctl参数" class="headerlink" title="修改sysctl参数"></a>修改sysctl参数</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo &quot;net.ipv4.ip_forward &#x3D; 1&quot; &gt;&gt;&#x2F;etc&#x2F;sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<h2 id="安装OpenVPN软件"><a href="#安装OpenVPN软件" class="headerlink" title="安装OpenVPN软件"></a>安装OpenVPN软件</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y openvpn easy-rsa lrzsz iptables-services</span><br></pre></td></tr></table></figure>

<h1 id="配置服务器证书"><a href="#配置服务器证书" class="headerlink" title="配置服务器证书"></a>配置服务器证书</h1><h2 id="复制文件"><a href="#复制文件" class="headerlink" title="复制文件"></a>复制文件</h2><blockquote>
<p>拷贝easy-rsa的文件到/etc/openvpn下</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cp -r &#x2F;usr&#x2F;share&#x2F;easy-rsa&#x2F;3.0.8 &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa</span><br><span class="line">cp &#x2F;usr&#x2F;share&#x2F;doc&#x2F;easy-rsa-3.0.8&#x2F;vars.example &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;vars</span><br></pre></td></tr></table></figure>

<h2 id="修改vars"><a href="#修改vars" class="headerlink" title="修改vars"></a>修改vars</h2><blockquote>
<p>编辑vars文件</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;vars</span><br></pre></td></tr></table></figure>

<blockquote>
<p>修改以下几项</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#set_var EASYRSA_REQ_COUNTRY     &quot;US&quot;</span><br><span class="line">#set_var EASYRSA_REQ_PROVINCE    &quot;California&quot;</span><br><span class="line">#set_var EASYRSA_REQ_CITY        &quot;San Francisco&quot;</span><br><span class="line">#set_var EASYRSA_REQ_ORG         &quot;Copyleft Certificate Co&quot;</span><br><span class="line">#set_var EASYRSA_REQ_EMAIL       &quot;me@example.net&quot;</span><br><span class="line">#set_var EASYRSA_REQ_OU          &quot;My Organizational Unit&quot;</span><br><span class="line">#set_var EASYRSA_KEY_SIZE        4096</span><br><span class="line">#set_var EASYRSA_ALGO            rsa</span><br><span class="line">#set_var EASYRSA_CA_EXPIRE       3650</span><br><span class="line">#set_var EASYRSA_CERT_EXPIRE     3650</span><br><span class="line">#set_var EASYRSA_CERT_RENEW      180</span><br><span class="line">#set_var EASYRSA_CRL_DAYS        60</span><br></pre></td></tr></table></figure>

<h2 id="初始化PKI和CA"><a href="#初始化PKI和CA" class="headerlink" title="初始化PKI和CA"></a>初始化PKI和CA</h2><h3 id="切换目录"><a href="#切换目录" class="headerlink" title="切换目录"></a>切换目录</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa</span><br></pre></td></tr></table></figure>

<h3 id="创建PKI"><a href="#创建PKI" class="headerlink" title="创建PKI"></a>创建PKI</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;easyrsa init-pki</span><br></pre></td></tr></table></figure>

<h3 id="创建CA"><a href="#创建CA" class="headerlink" title="创建CA"></a>创建CA</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;easyrsa build-ca nopass</span><br></pre></td></tr></table></figure>

<h2 id="创建服务器证书"><a href="#创建服务器证书" class="headerlink" title="创建服务器证书"></a>创建服务器证书</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;easyrsa build-server-full openvpn-server nopass</span><br></pre></td></tr></table></figure>

<h2 id="创建DH证书"><a href="#创建DH证书" class="headerlink" title="创建DH证书"></a>创建DH证书</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;easyrsa gen-dh</span><br></pre></td></tr></table></figure>

<h2 id="拷贝证书"><a href="#拷贝证书" class="headerlink" title="拷贝证书"></a>拷贝证书</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir -p &#x2F;etc&#x2F;openvpn&#x2F;pki</span><br><span class="line">cp &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;pki&#x2F;ca.crt \</span><br><span class="line">   &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;pki&#x2F;dh.pem \</span><br><span class="line">   &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;pki&#x2F;issued&#x2F;openvpn-server.crt \</span><br><span class="line">   &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;pki&#x2F;private&#x2F;openvpn-server.key \</span><br><span class="line">   &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;</span><br><span class="line">ln -sv &#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;pki&#x2F;crl.pem &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;crl.pem</span><br><span class="line">chown -R root:openvpn &#x2F;etc&#x2F;openvpn&#x2F;pki</span><br></pre></td></tr></table></figure>

<h2 id="创建ta-key"><a href="#创建ta-key" class="headerlink" title="创建ta.key"></a>创建ta.key</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">openvpn --genkey --secret &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;ta.key</span><br></pre></td></tr></table></figure>

<h1 id="配置OpenVPN"><a href="#配置OpenVPN" class="headerlink" title="配置OpenVPN"></a>配置OpenVPN</h1><h2 id="创建日志目录"><a href="#创建日志目录" class="headerlink" title="创建日志目录"></a>创建日志目录</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir -p &#x2F;var&#x2F;log&#x2F;openvpn</span><br><span class="line">chown -R openvpn:openvpn &#x2F;var&#x2F;log&#x2F;openvpn</span><br></pre></td></tr></table></figure>

<h2 id="创建客户端配置目录"><a href="#创建客户端配置目录" class="headerlink" title="创建客户端配置目录"></a>创建客户端配置目录</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir -p &#x2F;etc&#x2F;openvpn&#x2F;client&#x2F;&#123;config,user&#125;</span><br><span class="line">chown -R root:openvpn &#x2F;etc&#x2F;openvpn&#x2F;client&#x2F;&#123;config,user&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置OpenVPN服务器端"><a href="#配置OpenVPN服务器端" class="headerlink" title="配置OpenVPN服务器端"></a>配置OpenVPN服务器端</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;openvpn&#x2F;server&#x2F;srv.conf</span><br></pre></td></tr></table></figure>

<blockquote>
<p>下面内容按需更改</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 监听地址</span><br><span class="line">local 0.0.0.0</span><br><span class="line"># 监听端口</span><br><span class="line">port 51194</span><br><span class="line"># 通信协议</span><br><span class="line">proto tcp</span><br><span class="line"># TUN模式还是TAP模式</span><br><span class="line">dev tun</span><br><span class="line"># 证书</span><br><span class="line">ca         &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;ca.crt</span><br><span class="line">cert       &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;openvpn-server.crt</span><br><span class="line">key        &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;openvpn-server.key</span><br><span class="line">dh         &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;dh.pem</span><br><span class="line">crl-verify &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;crl.pem</span><br><span class="line"># 禁用OpenVPN自定义缓冲区大小，由操作系统控制</span><br><span class="line">sndbuf 0</span><br><span class="line">rcvbuf 0</span><br><span class="line"># TLS rules “client” | “server”</span><br><span class="line">remote-cert-tls  &quot;client&quot;</span><br><span class="line"># TLS认证</span><br><span class="line">tls-auth &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;ta.key</span><br><span class="line"># TLS最小版本</span><br><span class="line">#tls-version-min &quot;1.2&quot;</span><br><span class="line"># 重新协商数据交换的key，默认3600</span><br><span class="line">#reneg-sec 3600</span><br><span class="line"># 在此文件中维护客户端与虚拟IP地址之间的关联记录</span><br><span class="line"># 如果OpenVPN重启，重新连接的客户端可以被分配到先前分配的虚拟IP地址</span><br><span class="line">ifconfig-pool-persist &#x2F;etc&#x2F;openvpn&#x2F;ipp.txt</span><br><span class="line"># 配置client配置文件</span><br><span class="line">client-config-dir &#x2F;etc&#x2F;openvpn&#x2F;client&#x2F;config</span><br><span class="line"># 该网段为 open VPN 虚拟网卡网段，不要和内网网段冲突即可。</span><br><span class="line">server 10.8.0.0 255.255.255.0</span><br><span class="line"># 给客户端推送自定义路由</span><br><span class="line">#push &quot;route 192.168.0.0 255.255.255.0&quot;</span><br><span class="line"># 所有客户端的默认网关都将重定向到VPN</span><br><span class="line">#push &quot;redirect-gateway def1 bypass-dhcp&quot;  </span><br><span class="line"># 向客户端推送DNS配置</span><br><span class="line">#push &quot;dhcp-option DNS 223.5.5.5&quot;</span><br><span class="line">#push &quot;dhcp-option DNS 223.6.6.6&quot;</span><br><span class="line"># 允许客户端之间互相访问</span><br><span class="line">client-to-client</span><br><span class="line"># 限制最大客户端数量</span><br><span class="line">#max-clients 10</span><br><span class="line"># 客户端连接时运行脚本</span><br><span class="line">#client-connect ovpns.script</span><br><span class="line"># 客户端断开连接时运行脚本</span><br><span class="line">#client-disconnect ovpns.script</span><br><span class="line"># 保持连接时间</span><br><span class="line">keepalive 20 120</span><br><span class="line"># 开启vpn压缩</span><br><span class="line">comp-lzo</span><br><span class="line"># 允许多人使用同一个证书连接VPN，不建议使用，注释状态</span><br><span class="line">#duplicate-cn</span><br><span class="line"># 运行用户</span><br><span class="line">user openvpn</span><br><span class="line">#运行组</span><br><span class="line">group openvpn</span><br><span class="line"># 持久化选项可以尽量避免访问那些在重启之后由于用户权限降低而无法访问的某些资源</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line"># 显示当前的连接状态</span><br><span class="line">status      &#x2F;var&#x2F;log&#x2F;openvpn&#x2F;openvpn-status.log</span><br><span class="line"># 日志路径，不指定文件路径时输出到控制台</span><br><span class="line"># log代表每次启动时清空日志文件</span><br><span class="line">#log        &#x2F;var&#x2F;log&#x2F;openvpn&#x2F;openvpn.log</span><br><span class="line"># log-append代表追加写入到日志文件</span><br><span class="line">#log-append  &#x2F;var&#x2F;log&#x2F;openvpn&#x2F;openvpn.log</span><br><span class="line"># 日志级别</span><br><span class="line">verb 4</span><br><span class="line"># 忽略过多的重复信息，相同类别的信息只有前20条会输出到日志文件中</span><br><span class="line">mute 20</span><br></pre></td></tr></table></figure>

<h2 id="启动OpenVPN-server"><a href="#启动OpenVPN-server" class="headerlink" title="启动OpenVPN-server"></a>启动OpenVPN-server</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chown -R root:openvpn &#x2F;etc&#x2F;openvpn</span><br><span class="line">systemctl enable openvpn-server@srv.service</span><br><span class="line">systemctl start openvpn-server@srv.service</span><br></pre></td></tr></table></figure>

<h2 id="开启iptables策略"><a href="#开启iptables策略" class="headerlink" title="开启iptables策略"></a>开启iptables策略</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iptables -t nat -A POSTROUTING -s 10.8.0.0&#x2F;24 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<h2 id="定期更新CRL"><a href="#定期更新CRL" class="headerlink" title="定期更新CRL"></a>定期更新CRL</h2><h3 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h3><ul>
<li>OpenVPN的server配置里面添加了<code>crl-verify</code>之后，需要给crl定期更新</li>
<li>如果crl文件长期不更新，过期之后，OpenVPN会报无法验证证书，导致无法连接OpenVPN</li>
</ul>
<h3 id="配置systemd-timer"><a href="#配置systemd-timer" class="headerlink" title="配置systemd timer"></a>配置systemd timer</h3><h3 id="定义Service"><a href="#定义Service" class="headerlink" title="定义Service"></a>定义Service</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;easyrsa-gen-crl.service</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;easyrsa-gen-crl</span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;oneshot</span><br><span class="line"># 重新生成CRL文件</span><br><span class="line">ExecStart&#x3D;&#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&#x2F;easyrsa gen-crl</span><br><span class="line"># 命令完成之后重启OpenVPN服务</span><br><span class="line">ExecStartPost&#x3D;&#x2F;usr&#x2F;bin&#x2F;systemctl restart openvpn-server@srv.service</span><br><span class="line">WorkingDirectory&#x3D;&#x2F;etc&#x2F;openvpn&#x2F;easy-rsa</span><br></pre></td></tr></table></figure>

<h3 id="定义timer"><a href="#定义timer" class="headerlink" title="定义timer"></a>定义timer</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;easyrsa-gen-crl.timer</span><br><span class="line">[Unit]</span><br><span class="line">Description&#x3D;easyrsa-gen-crl</span><br><span class="line"></span><br><span class="line">[Timer]</span><br><span class="line"># 每周一凌晨4点触发easyrsa-gen-crl.service</span><br><span class="line">OnCalendar&#x3D;Mon *-*-* 04:00:00</span><br><span class="line">Persistent&#x3D;true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy&#x3D;timers.target</span><br></pre></td></tr></table></figure>

<h3 id="启动timer"><a href="#启动timer" class="headerlink" title="启动timer"></a>启动timer</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl enable easyrsa-gen-crl.timer</span><br><span class="line">systemctl start easyrsa-gen-crl.timer</span><br></pre></td></tr></table></figure>

<h3 id="立刻启动service"><a href="#立刻启动service" class="headerlink" title="立刻启动service"></a>立刻启动service</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start easy-rsa-gen-crl.service</span><br></pre></td></tr></table></figure>

<h3 id="查看Service日志"><a href="#查看Service日志" class="headerlink" title="查看Service日志"></a>查看Service日志</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">journalctl -xfu easy-rsa-gen-crl.service</span><br></pre></td></tr></table></figure>

<h3 id="查看timer状态"><a href="#查看timer状态" class="headerlink" title="查看timer状态"></a>查看timer状态</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl status easyrsa-gen-crl.timer</span><br></pre></td></tr></table></figure>

<h1 id="客户端管理"><a href="#客户端管理" class="headerlink" title="客户端管理"></a>客户端管理</h1><h2 id="客户端配置模板"><a href="#客户端配置模板" class="headerlink" title="客户端配置模板"></a>客户端配置模板</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;openvpn&#x2F;templates&#x2F;ovpn.template</span><br><span class="line"># 配置为客户端模式</span><br><span class="line">client</span><br><span class="line"># 与服务器端保持一致</span><br><span class="line">proto tcp</span><br><span class="line"># 与服务器端保持一致</span><br><span class="line">dev tun</span><br><span class="line"># 配置服务器端的地址和端口</span><br><span class="line">remote 服务端ip 51194</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">comp-lzo</span><br><span class="line">nice 0</span><br><span class="line">verb 3</span><br><span class="line">mute 10</span><br><span class="line"># 禁用OpenVPN自定义缓冲区大小，由操作系统控制</span><br><span class="line">sndbuf 0</span><br><span class="line">rcvbuf 0</span><br><span class="line"># 禁止在内存中缓存password</span><br><span class="line">auth-nocache</span><br><span class="line"># TLS rules “client” | “server”</span><br><span class="line">remote-cert-tls server</span><br><span class="line"># 过滤从服务器端发过来的路由规则</span><br><span class="line">#pull-filter ignore redirect-gateway</span><br><span class="line"># 不从服务器端拉取路由规则</span><br><span class="line">#route-nopull</span><br><span class="line"># 手动指定所有流量走VPN</span><br><span class="line">#redirect-gateway def1</span><br><span class="line"># 客户端自定义路由，例如192.168.0.0&#x2F;24走VPN，192.168.1.0&#x2F;24不走VPN</span><br><span class="line">#route 192.168.0.0 255.255.255.0 vpn_gateway</span><br><span class="line">#route 192.168.1.0 255.255.255.0 net_gateway</span><br></pre></td></tr></table></figure>

<h2 id="指定客户端推送配置"><a href="#指定客户端推送配置" class="headerlink" title="指定客户端推送配置"></a>指定客户端推送配置</h2><h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;openvpn&#x2F;templates&#x2F;ipconfig_push.template</span><br><span class="line"># 给客户端推送固定的IP地址</span><br><span class="line">ifconfig-push #ipaddress# 255.255.255.0</span><br><span class="line"># 给客户端推送路由</span><br><span class="line">#iroute 172.17.0.0 255.255.0.0</span><br></pre></td></tr></table></figure>

<h3 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;openvpn&#x2F;client&#x2F;config&#x2F;user1</span><br><span class="line"># 给客户端推送固定的IP地址10.8.0.100</span><br><span class="line">ifconfig-push 10.8.0.100 255.255.255.0</span><br></pre></td></tr></table></figure>

<h2 id="用户管理脚本"><a href="#用户管理脚本" class="headerlink" title="用户管理脚本"></a>用户管理脚本</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;usr&#x2F;local&#x2F;bin&#x2F;ovpn_mgmt.sh</span><br><span class="line">chmod +x &#x2F;usr&#x2F;local&#x2F;bin&#x2F;ovpn_mgmt.sh</span><br><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line"># 定义环境变量</span><br><span class="line">export EASY_RSA_DIR&#x3D;&quot;&#x2F;etc&#x2F;openvpn&#x2F;easy-rsa&quot;</span><br><span class="line">export CLIENT_CONFIG_DIR&#x3D;&quot;&#x2F;etc&#x2F;openvpn&#x2F;client&#x2F;config&quot;</span><br><span class="line">export PKI_DIR&#x3D;&quot;$&#123;EASY_RSA_DIR&#125;&#x2F;pki&quot;</span><br><span class="line">export TEMPLATES_DIR&#x3D;&quot;&#x2F;etc&#x2F;openvpn&#x2F;templates&quot;</span><br><span class="line">export CLIENT_USER_DIR&#x3D;&quot;&#x2F;etc&#x2F;openvpn&#x2F;client&#x2F;user&quot;</span><br><span class="line"></span><br><span class="line"># 创建ovpn配置</span><br><span class="line">generate_ovpn() &#123;</span><br><span class="line">	USER_OVPN&#x3D;&quot;$&#123;CLIENT_USER_DIR&#125;&#x2F;$&#123;EXPIRED&#125;-$&#123;USER&#125;.ovpn&quot;</span><br><span class="line">	# 根据证书生成对应的ovpn文件</span><br><span class="line">    mkdir -p  $&#123;CLIENT_USER_DIR&#125;&#x2F;</span><br><span class="line">    cp -f $&#123;TEMPLATES_DIR&#125;&#x2F;ovpn.template $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;ca&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat $&#123;PKI_DIR&#125;&#x2F;ca.crt &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;&#x2F;ca&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;cert&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat $&#123;PKI_DIR&#125;&#x2F;issued&#x2F;$&#123;USER&#125;.crt &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;&#x2F;cert&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;key&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat $&#123;PKI_DIR&#125;&#x2F;private&#x2F;$&#123;USER&#125;.key &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;&#x2F;key&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;tls-auth&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    cat &#x2F;etc&#x2F;openvpn&#x2F;pki&#x2F;ta.key &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    echo &quot;&lt;&#x2F;tls-auth&gt;&quot; &gt;&gt; $&#123;USER_OVPN&#125;</span><br><span class="line">    sz --binary $&#123;USER_OVPN&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 添加客户端IP</span><br><span class="line">client_ip_config() &#123;</span><br><span class="line">	# 根据ip地址生成对应的client-config</span><br><span class="line">    sed -e &quot;s,#ipaddress#,$&#123;IPADDRESS&#125;,g&quot; \</span><br><span class="line">        $&#123;TEMPLATES_DIR&#125;&#x2F;ipconfig_push.template \</span><br><span class="line">        &gt; $&#123;CLIENT_CONFIG_DIR&#125;&#x2F;$&#123;USER&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 生成客户端证书</span><br><span class="line">add_cert() &#123;</span><br><span class="line">	# 切换到easy-rsa目录</span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    $&#123;EASY_RSA_DIR&#125;&#x2F;easyrsa build-client-full $&#123;USER&#125; nopass</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 注销客户端证书</span><br><span class="line">revoke_cert() &#123;</span><br><span class="line">	# 切换到easy-rsa目录</span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    echo &quot;yes&quot; | $&#123;EASY_RSA_DIR&#125;&#x2F;easyrsa revoke $&#123;USER&#125;</span><br><span class="line">	$&#123;EASY_RSA_DIR&#125;&#x2F;easyrsa gen-crl</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 更新客户端证书</span><br><span class="line">renew_cert() &#123;</span><br><span class="line">	# 切换到easy-rsa目录</span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    echo &quot;yes&quot; | $&#123;EASY_RSA_DIR&#125;&#x2F;easyrsa renew $&#123;USER&#125; nopass</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 检查证书过期时间</span><br><span class="line">check_cert_expired() &#123;</span><br><span class="line">	export EXPIRED&#x3D;$(date --date&#x3D;&quot;$(openssl x509 -enddate -noout -in $&#123;PKI_DIR&#125;&#x2F;issued&#x2F;$&#123;USER&#125;.crt |cut -d&#x3D; -f 2)&quot; --iso-8601)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 创建用户</span><br><span class="line">add_user() &#123;</span><br><span class="line">	if [[ -e &quot;$&#123;EASY_RSA_DIR&#125;&#x2F;pki&#x2F;reqs&#x2F;$&#123;USER&#125;.req&quot; ]];then</span><br><span class="line">		read -p&quot;此用户已经申请证书，是否重新生成？[y&#x2F;n]：&quot; ANSWER</span><br><span class="line">		case $&#123;ANSWER&#125; in</span><br><span class="line">		    y|Y)</span><br><span class="line">		        revoke_cert</span><br><span class="line">		        check_cert_expired</span><br><span class="line">		        client_ip_config</span><br><span class="line">		        add_cert</span><br><span class="line">		        generate_ovpn</span><br><span class="line">		        exit 0</span><br><span class="line">		        ;;</span><br><span class="line">			n|N)</span><br><span class="line">				check_cert_expired</span><br><span class="line">				client_ip_config</span><br><span class="line">				generate_ovpn</span><br><span class="line">				;;</span><br><span class="line">		esac</span><br><span class="line">	else</span><br><span class="line">		add_cert</span><br><span class="line">		check_cert_expired</span><br><span class="line">		client_ip_config</span><br><span class="line">		generate_ovpn</span><br><span class="line">	fi</span><br><span class="line">&#125;</span><br><span class="line"># 删除用户</span><br><span class="line">del_user() &#123;</span><br><span class="line">	revoke_cert</span><br><span class="line">	rm -rf $&#123;CLIENT_USER_DIR&#125;&#x2F;*$&#123;USER&#125;.ovpn</span><br><span class="line">	rm -rf $&#123;CLIENT_CONFIG_DIR&#125;&#x2F;$&#123;USER&#125;</span><br><span class="line">&#125;</span><br><span class="line"># 用户旧证过期重新生成证书</span><br><span class="line">renew_user() &#123;</span><br><span class="line">	if [[ -e &quot;$&#123;EASY_RSA_DIR&#125;&#x2F;pki&#x2F;reqs&#x2F;$&#123;USER&#125;.req&quot; ]];then</span><br><span class="line">        renew_cert</span><br><span class="line">        check_cert_expired</span><br><span class="line">        generate_ovpn</span><br><span class="line">    else</span><br><span class="line">    	echo &quot;用户证书不存在！&quot;</span><br><span class="line">    	exit 1</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">    # 切换到easy-rsa目录</span><br><span class="line">    cd $&#123;EASY_RSA_DIR&#125;</span><br><span class="line">    # 根据传入的method运行对应函数</span><br><span class="line">    $&#123;METHOD&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 获取参数</span><br><span class="line">while getopts &#39;m:u:i:r&#39; OPT;do</span><br><span class="line">    case $OPT in</span><br><span class="line">        u)</span><br><span class="line">            USER&#x3D;&quot;$OPTARG&quot;</span><br><span class="line">            echo &quot;USER&#x3D;$&#123;USER&#125;&quot;</span><br><span class="line">            ;;</span><br><span class="line">        i)</span><br><span class="line">            IPADDRESS&#x3D;&quot;$OPTARG&quot;</span><br><span class="line">            echo &quot;IPADDRESS&#x3D;$&#123;IPADDRESS&#125;&quot;</span><br><span class="line">            ;;</span><br><span class="line">        m)</span><br><span class="line">            METHOD&#x3D;&quot;$OPTARG&quot;</span><br><span class="line">            echo &quot;METHOD&#x3D;$&#123;METHOD&#125;&quot;</span><br><span class="line">            ;;</span><br><span class="line">        ?)</span><br><span class="line">            echo &quot;Usage: $(base \&quot;$0\&quot;) -m [add_user|del_user|renew_user] -u USER -i IPADDRESS&quot;</span><br><span class="line">            exit 0</span><br><span class="line">            ;;</span><br><span class="line">    esac</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">main</span><br></pre></td></tr></table></figure>

<h2 id="添加用户"><a href="#添加用户" class="headerlink" title="添加用户"></a>添加用户</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;ovpn_mgmt.sh -m add_user -u USERNAME -i 10.8.0.10</span><br></pre></td></tr></table></figure>

<h2 id="删除用户"><a href="#删除用户" class="headerlink" title="删除用户"></a>删除用户</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;bin&#x2F;ovpn_mgmt.sh -m del_user -u USERNAME</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>centos</category>
      </categories>
      <tags>
        <tag>centos</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s部署nacos集群</title>
    <url>/2020/12/02/k8s%E9%83%A8%E7%BD%B2nacos%E9%9B%86%E7%BE%A4/</url>
    <content><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>​        根据GitHub上k8s搭建nacos集群教程部署后，手动删除pod，leader无法正常选举，于是改用deployment部署，因未使用nacos持久化实例，所以未挂载共享存储，有需要可以自行配置。</p>
<a id="more"></a>


<ul>
<li><p>k8s集群版本：<code>1.18.8-aliyun.1</code></p>
</li>
<li><p>nacos版本：<code>1.3.2</code></p>
</li>
<li><p>Pod控制器：<code>Deployment</code></p>
</li>
<li><p>服务器数量：<code>3</code></p>
</li>
<li><p>Deployment数量：<code>3</code></p>
</li>
<li><p>数据库版本：<code>阿里云RDS mysql8.0</code></p>
</li>
</ul>
<h1 id="初始化sql"><a href="#初始化sql" class="headerlink" title="初始化sql"></a>初始化sql</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE &#96;config_info&#96; (</span><br><span class="line">  &#96;id&#96; bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#39;id&#39;,</span><br><span class="line">  &#96;data_id&#96; varchar(255) NOT NULL COMMENT &#39;data_id&#39;,</span><br><span class="line">  &#96;group_id&#96; varchar(255) DEFAULT NULL,</span><br><span class="line">  &#96;content&#96; longtext NOT NULL COMMENT &#39;content&#39;,</span><br><span class="line">  &#96;md5&#96; varchar(32) DEFAULT NULL COMMENT &#39;md5&#39;,</span><br><span class="line">  &#96;gmt_create&#96; datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,</span><br><span class="line">  &#96;gmt_modified&#96; datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;修改时间&#39;,</span><br><span class="line">  &#96;src_user&#96; text COMMENT &#39;source user&#39;,</span><br><span class="line">  &#96;src_ip&#96; varchar(20) DEFAULT NULL COMMENT &#39;source ip&#39;,</span><br><span class="line">  &#96;app_name&#96; varchar(128) DEFAULT NULL,</span><br><span class="line">  &#96;tenant_id&#96; varchar(128) DEFAULT &#39;&#39; COMMENT &#39;租户字段&#39;,</span><br><span class="line">  &#96;c_desc&#96; varchar(256) DEFAULT NULL,</span><br><span class="line">  &#96;c_use&#96; varchar(64) DEFAULT NULL,</span><br><span class="line">  &#96;effect&#96; varchar(64) DEFAULT NULL,</span><br><span class="line">  &#96;type&#96; varchar(64) DEFAULT NULL,</span><br><span class="line">  &#96;c_schema&#96; text,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;),</span><br><span class="line">  UNIQUE KEY &#96;uk_configinfo_datagrouptenant&#96; (&#96;data_id&#96;,&#96;group_id&#96;,&#96;tenant_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 COLLATE&#x3D;utf8_bin COMMENT&#x3D;&#39;config_info&#39;;</span><br><span class="line"></span><br><span class="line">&#x2F;******************************************&#x2F;</span><br><span class="line">&#x2F;*   数据库全名 &#x3D; nacos_config   *&#x2F;</span><br><span class="line">&#x2F;*   表名称 &#x3D; config_info_aggr   *&#x2F;</span><br><span class="line">&#x2F;******************************************&#x2F;</span><br><span class="line">CREATE TABLE &#96;config_info_aggr&#96; (</span><br><span class="line">  &#96;id&#96; bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#39;id&#39;,</span><br><span class="line">  &#96;data_id&#96; varchar(255) NOT NULL COMMENT &#39;data_id&#39;,</span><br><span class="line">  &#96;group_id&#96; varchar(255) NOT NULL COMMENT &#39;group_id&#39;,</span><br><span class="line">  &#96;datum_id&#96; varchar(255) NOT NULL COMMENT &#39;datum_id&#39;,</span><br><span class="line">  &#96;content&#96; longtext NOT NULL COMMENT &#39;内容&#39;,</span><br><span class="line">  &#96;gmt_modified&#96; datetime NOT NULL COMMENT &#39;修改时间&#39;,</span><br><span class="line">  &#96;app_name&#96; varchar(128) DEFAULT NULL,</span><br><span class="line">  &#96;tenant_id&#96; varchar(128) DEFAULT &#39;&#39; COMMENT &#39;租户字段&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;),</span><br><span class="line">  UNIQUE KEY &#96;uk_configinfoaggr_datagrouptenantdatum&#96; (&#96;data_id&#96;,&#96;group_id&#96;,&#96;tenant_id&#96;,&#96;datum_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 COLLATE&#x3D;utf8_bin COMMENT&#x3D;&#39;增加租户字段&#39;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;******************************************&#x2F;</span><br><span class="line">&#x2F;*   数据库全名 &#x3D; nacos_config   *&#x2F;</span><br><span class="line">&#x2F;*   表名称 &#x3D; config_info_beta   *&#x2F;</span><br><span class="line">&#x2F;******************************************&#x2F;</span><br><span class="line">CREATE TABLE &#96;config_info_beta&#96; (</span><br><span class="line">  &#96;id&#96; bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#39;id&#39;,</span><br><span class="line">  &#96;data_id&#96; varchar(255) NOT NULL COMMENT &#39;data_id&#39;,</span><br><span class="line">  &#96;group_id&#96; varchar(128) NOT NULL COMMENT &#39;group_id&#39;,</span><br><span class="line">  &#96;app_name&#96; varchar(128) DEFAULT NULL COMMENT &#39;app_name&#39;,</span><br><span class="line">  &#96;content&#96; longtext NOT NULL COMMENT &#39;content&#39;,</span><br><span class="line">  &#96;beta_ips&#96; varchar(1024) DEFAULT NULL COMMENT &#39;betaIps&#39;,</span><br><span class="line">  &#96;md5&#96; varchar(32) DEFAULT NULL COMMENT &#39;md5&#39;,</span><br><span class="line">  &#96;gmt_create&#96; datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,</span><br><span class="line">  &#96;gmt_modified&#96; datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;修改时间&#39;,</span><br><span class="line">  &#96;src_user&#96; text COMMENT &#39;source user&#39;,</span><br><span class="line">  &#96;src_ip&#96; varchar(20) DEFAULT NULL COMMENT &#39;source ip&#39;,</span><br><span class="line">  &#96;tenant_id&#96; varchar(128) DEFAULT &#39;&#39; COMMENT &#39;租户字段&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;),</span><br><span class="line">  UNIQUE KEY &#96;uk_configinfobeta_datagrouptenant&#96; (&#96;data_id&#96;,&#96;group_id&#96;,&#96;tenant_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 COLLATE&#x3D;utf8_bin COMMENT&#x3D;&#39;config_info_beta&#39;;</span><br><span class="line"></span><br><span class="line">&#x2F;******************************************&#x2F;</span><br><span class="line">&#x2F;*   数据库全名 &#x3D; nacos_config   *&#x2F;</span><br><span class="line">&#x2F;*   表名称 &#x3D; config_info_tag   *&#x2F;</span><br><span class="line">&#x2F;******************************************&#x2F;</span><br><span class="line">CREATE TABLE &#96;config_info_tag&#96; (</span><br><span class="line">  &#96;id&#96; bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#39;id&#39;,</span><br><span class="line">  &#96;data_id&#96; varchar(255) NOT NULL COMMENT &#39;data_id&#39;,</span><br><span class="line">  &#96;group_id&#96; varchar(128) NOT NULL COMMENT &#39;group_id&#39;,</span><br><span class="line">  &#96;tenant_id&#96; varchar(128) DEFAULT &#39;&#39; COMMENT &#39;tenant_id&#39;,</span><br><span class="line">  &#96;tag_id&#96; varchar(128) NOT NULL COMMENT &#39;tag_id&#39;,</span><br><span class="line">  &#96;app_name&#96; varchar(128) DEFAULT NULL COMMENT &#39;app_name&#39;,</span><br><span class="line">  &#96;content&#96; longtext NOT NULL COMMENT &#39;content&#39;,</span><br><span class="line">  &#96;md5&#96; varchar(32) DEFAULT NULL COMMENT &#39;md5&#39;,</span><br><span class="line">  &#96;gmt_create&#96; datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,</span><br><span class="line">  &#96;gmt_modified&#96; datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;修改时间&#39;,</span><br><span class="line">  &#96;src_user&#96; text COMMENT &#39;source user&#39;,</span><br><span class="line">  &#96;src_ip&#96; varchar(20) DEFAULT NULL COMMENT &#39;source ip&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;),</span><br><span class="line">  UNIQUE KEY &#96;uk_configinfotag_datagrouptenanttag&#96; (&#96;data_id&#96;,&#96;group_id&#96;,&#96;tenant_id&#96;,&#96;tag_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 COLLATE&#x3D;utf8_bin COMMENT&#x3D;&#39;config_info_tag&#39;;</span><br><span class="line"></span><br><span class="line">&#x2F;******************************************&#x2F;</span><br><span class="line">&#x2F;*   数据库全名 &#x3D; nacos_config   *&#x2F;</span><br><span class="line">&#x2F;*   表名称 &#x3D; config_tags_relation   *&#x2F;</span><br><span class="line">&#x2F;******************************************&#x2F;</span><br><span class="line">CREATE TABLE &#96;config_tags_relation&#96; (</span><br><span class="line">  &#96;id&#96; bigint(20) NOT NULL COMMENT &#39;id&#39;,</span><br><span class="line">  &#96;tag_name&#96; varchar(128) NOT NULL COMMENT &#39;tag_name&#39;,</span><br><span class="line">  &#96;tag_type&#96; varchar(64) DEFAULT NULL COMMENT &#39;tag_type&#39;,</span><br><span class="line">  &#96;data_id&#96; varchar(255) NOT NULL COMMENT &#39;data_id&#39;,</span><br><span class="line">  &#96;group_id&#96; varchar(128) NOT NULL COMMENT &#39;group_id&#39;,</span><br><span class="line">  &#96;tenant_id&#96; varchar(128) DEFAULT &#39;&#39; COMMENT &#39;tenant_id&#39;,</span><br><span class="line">  &#96;nid&#96; bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  PRIMARY KEY (&#96;nid&#96;),</span><br><span class="line">  UNIQUE KEY &#96;uk_configtagrelation_configidtag&#96; (&#96;id&#96;,&#96;tag_name&#96;,&#96;tag_type&#96;),</span><br><span class="line">  KEY &#96;idx_tenant_id&#96; (&#96;tenant_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 COLLATE&#x3D;utf8_bin COMMENT&#x3D;&#39;config_tag_relation&#39;;</span><br><span class="line"></span><br><span class="line">&#x2F;******************************************&#x2F;</span><br><span class="line">&#x2F;*   数据库全名 &#x3D; nacos_config   *&#x2F;</span><br><span class="line">&#x2F;*   表名称 &#x3D; group_capacity   *&#x2F;</span><br><span class="line">&#x2F;******************************************&#x2F;</span><br><span class="line">CREATE TABLE &#96;group_capacity&#96; (</span><br><span class="line">  &#96;id&#96; bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;主键ID&#39;,</span><br><span class="line">  &#96;group_id&#96; varchar(128) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;Group ID，空字符表示整个集群&#39;,</span><br><span class="line">  &#96;quota&#96; int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;配额，0表示使用默认值&#39;,</span><br><span class="line">  &#96;usage&#96; int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;使用量&#39;,</span><br><span class="line">  &#96;max_size&#96; int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;单个配置大小上限，单位为字节，0表示使用默认值&#39;,</span><br><span class="line">  &#96;max_aggr_count&#96; int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;聚合子配置最大个数，，0表示使用默认值&#39;,</span><br><span class="line">  &#96;max_aggr_size&#96; int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#39;,</span><br><span class="line">  &#96;max_history_count&#96; int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;最大变更历史数量&#39;,</span><br><span class="line">  &#96;gmt_create&#96; datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,</span><br><span class="line">  &#96;gmt_modified&#96; datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;修改时间&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;),</span><br><span class="line">  UNIQUE KEY &#96;uk_group_id&#96; (&#96;group_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 COLLATE&#x3D;utf8_bin COMMENT&#x3D;&#39;集群、各Group容量信息表&#39;;</span><br><span class="line"></span><br><span class="line">&#x2F;******************************************&#x2F;</span><br><span class="line">&#x2F;*   数据库全名 &#x3D; nacos_config   *&#x2F;</span><br><span class="line">&#x2F;*   表名称 &#x3D; his_config_info   *&#x2F;</span><br><span class="line">&#x2F;******************************************&#x2F;</span><br><span class="line">CREATE TABLE &#96;his_config_info&#96; (</span><br><span class="line">  &#96;id&#96; bigint(64) unsigned NOT NULL,</span><br><span class="line">  &#96;nid&#96; bigint(20) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;data_id&#96; varchar(255) NOT NULL,</span><br><span class="line">  &#96;group_id&#96; varchar(128) NOT NULL,</span><br><span class="line">  &#96;app_name&#96; varchar(128) DEFAULT NULL COMMENT &#39;app_name&#39;,</span><br><span class="line">  &#96;content&#96; longtext NOT NULL,</span><br><span class="line">  &#96;md5&#96; varchar(32) DEFAULT NULL,</span><br><span class="line">  &#96;gmt_create&#96; datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">  &#96;gmt_modified&#96; datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">  &#96;src_user&#96; text,</span><br><span class="line">  &#96;src_ip&#96; varchar(20) DEFAULT NULL,</span><br><span class="line">  &#96;op_type&#96; char(10) DEFAULT NULL,</span><br><span class="line">  &#96;tenant_id&#96; varchar(128) DEFAULT &#39;&#39; COMMENT &#39;租户字段&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;nid&#96;),</span><br><span class="line">  KEY &#96;idx_gmt_create&#96; (&#96;gmt_create&#96;),</span><br><span class="line">  KEY &#96;idx_gmt_modified&#96; (&#96;gmt_modified&#96;),</span><br><span class="line">  KEY &#96;idx_did&#96; (&#96;data_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 COLLATE&#x3D;utf8_bin COMMENT&#x3D;&#39;多租户改造&#39;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;******************************************&#x2F;</span><br><span class="line">&#x2F;*   数据库全名 &#x3D; nacos_config   *&#x2F;</span><br><span class="line">&#x2F;*   表名称 &#x3D; tenant_capacity   *&#x2F;</span><br><span class="line">&#x2F;******************************************&#x2F;</span><br><span class="line">CREATE TABLE &#96;tenant_capacity&#96; (</span><br><span class="line">  &#96;id&#96; bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;主键ID&#39;,</span><br><span class="line">  &#96;tenant_id&#96; varchar(128) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;Tenant ID&#39;,</span><br><span class="line">  &#96;quota&#96; int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;配额，0表示使用默认值&#39;,</span><br><span class="line">  &#96;usage&#96; int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;使用量&#39;,</span><br><span class="line">  &#96;max_size&#96; int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;单个配置大小上限，单位为字节，0表示使用默认值&#39;,</span><br><span class="line">  &#96;max_aggr_count&#96; int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;聚合子配置最大个数&#39;,</span><br><span class="line">  &#96;max_aggr_size&#96; int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#39;,</span><br><span class="line">  &#96;max_history_count&#96; int(10) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;最大变更历史数量&#39;,</span><br><span class="line">  &#96;gmt_create&#96; datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,</span><br><span class="line">  &#96;gmt_modified&#96; datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;修改时间&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;),</span><br><span class="line">  UNIQUE KEY &#96;uk_tenant_id&#96; (&#96;tenant_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 COLLATE&#x3D;utf8_bin COMMENT&#x3D;&#39;租户容量信息表&#39;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;tenant_info&#96; (</span><br><span class="line">  &#96;id&#96; bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#39;id&#39;,</span><br><span class="line">  &#96;kp&#96; varchar(128) NOT NULL COMMENT &#39;kp&#39;,</span><br><span class="line">  &#96;tenant_id&#96; varchar(128) default &#39;&#39; COMMENT &#39;tenant_id&#39;,</span><br><span class="line">  &#96;tenant_name&#96; varchar(128) default &#39;&#39; COMMENT &#39;tenant_name&#39;,</span><br><span class="line">  &#96;tenant_desc&#96; varchar(256) DEFAULT NULL COMMENT &#39;tenant_desc&#39;,</span><br><span class="line">  &#96;create_source&#96; varchar(32) DEFAULT NULL COMMENT &#39;create_source&#39;,</span><br><span class="line">  &#96;gmt_create&#96; bigint(20) NOT NULL COMMENT &#39;创建时间&#39;,</span><br><span class="line">  &#96;gmt_modified&#96; bigint(20) NOT NULL COMMENT &#39;修改时间&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;),</span><br><span class="line">  UNIQUE KEY &#96;uk_tenant_info_kptenantid&#96; (&#96;kp&#96;,&#96;tenant_id&#96;),</span><br><span class="line">  KEY &#96;idx_tenant_id&#96; (&#96;tenant_id&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 COLLATE&#x3D;utf8_bin COMMENT&#x3D;&#39;tenant_info&#39;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;users&#96; (</span><br><span class="line">	&#96;username&#96; varchar(50) NOT NULL PRIMARY KEY,</span><br><span class="line">	&#96;password&#96; varchar(500) NOT NULL,</span><br><span class="line">	&#96;enabled&#96; boolean NOT NULL</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;roles&#96; (</span><br><span class="line">	&#96;username&#96; varchar(50) NOT NULL,</span><br><span class="line">	&#96;role&#96; varchar(50) NOT NULL,</span><br><span class="line">	UNIQUE INDEX &#96;idx_user_role&#96; (&#96;username&#96; ASC, &#96;role&#96; ASC) USING BTREE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;permissions&#96; (</span><br><span class="line">    &#96;role&#96; varchar(50) NOT NULL,</span><br><span class="line">    &#96;resource&#96; varchar(255) NOT NULL,</span><br><span class="line">    &#96;action&#96; varchar(8) NOT NULL,</span><br><span class="line">    UNIQUE INDEX &#96;uk_role_permission&#96; (&#96;role&#96;,&#96;resource&#96;,&#96;action&#96;) USING BTREE</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">INSERT INTO users (username, password, enabled) VALUES (&#39;nacos&#39;, &#39;$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu&#39;, TRUE);</span><br><span class="line"></span><br><span class="line">INSERT INTO roles (username, role) VALUES (&#39;nacos&#39;, &#39;ROLE_ADMIN&#39;);</span><br></pre></td></tr></table></figure>

<h1 id="YAML文件"><a href="#YAML文件" class="headerlink" title="YAML文件"></a>YAML文件</h1><h2 id="configmap"><a href="#configmap" class="headerlink" title="configmap"></a>configmap</h2><ul>
<li>自行调整数据库连接信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap </span><br><span class="line">metadata:</span><br><span class="line">  name: nacos-cloud-config</span><br><span class="line">  namespace: pro</span><br><span class="line">data: </span><br><span class="line">  cluster.conf: |</span><br><span class="line">        192.168.10.1:8848</span><br><span class="line">        192.168.10.2:8848</span><br><span class="line">        192.168.10.3:8848</span><br><span class="line">  application.properties: |</span><br><span class="line">        server.contextPath&#x3D;&#x2F;nacos</span><br><span class="line">        server.servlet.contextPath&#x3D;&#x2F;nacos</span><br><span class="line">        server.port&#x3D;8848</span><br><span class="line">        management.metrics.export.elastic.enabled&#x3D;false</span><br><span class="line">        management.metrics.export.influx.enabled&#x3D;false</span><br><span class="line">        server.tomcat.accesslog.enabled&#x3D;true</span><br><span class="line">        server.tomcat.accesslog.pattern&#x3D;%h %l %u %t &quot;%r&quot; %s %b %D %&#123;User-Agent&#125;i</span><br><span class="line">        server.tomcat.basedir&#x3D;</span><br><span class="line">        nacos.security.ignore.urls&#x3D;&#x2F;,&#x2F;**&#x2F;*.css,&#x2F;**&#x2F;*.js,&#x2F;**&#x2F;*.html,&#x2F;**&#x2F;*.map,&#x2F;**&#x2F;*.svg,&#x2F;**&#x2F;*.png,&#x2F;**&#x2F;*.ico,&#x2F;console-fe&#x2F;public&#x2F;**,&#x2F;v1&#x2F;auth&#x2F;login,&#x2F;v1&#x2F;console&#x2F;health&#x2F;**,&#x2F;v1&#x2F;cs&#x2F;**,&#x2F;v1&#x2F;ns&#x2F;**,&#x2F;v1&#x2F;cmdb&#x2F;**,&#x2F;actuator&#x2F;**,&#x2F;v1&#x2F;console&#x2F;server&#x2F;**</span><br><span class="line">        spring.datasource.platform&#x3D;mysql</span><br><span class="line">        db.num&#x3D;1</span><br><span class="line">        db.url.0&#x3D;jdbc:mysql:&#x2F;&#x2F;数据库地址:3306&#x2F;数据名?characterEncoding&#x3D;utf8&amp;connectTimeout&#x3D;1000&amp;socketTimeout&#x3D;3000&amp;autoReconnect&#x3D;true</span><br><span class="line">        db.user&#x3D;</span><br><span class="line">        db.password&#x3D;</span><br><span class="line">  nacos-logback.xml: |</span><br><span class="line">        &lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">        &lt;configuration scan&#x3D;&quot;true&quot; scanPeriod&#x3D;&quot;10 seconds&quot;&gt;</span><br><span class="line"></span><br><span class="line">                &lt;springProperty scope&#x3D;&quot;context&quot; name&#x3D;&quot;logPath&quot; source&#x3D;&quot;nacos.logs.path&quot; defaultValue&#x3D;&quot;$&#123;nacos.home&#125;&#x2F;logs&quot;&#x2F;&gt;</span><br><span class="line">                &lt;property name&#x3D;&quot;LOG_HOME&quot; value&#x3D;&quot;$&#123;logPath&#125;&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;cmdb-main&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;nacos.home&#125;&#x2F;logs&#x2F;cmdb-main.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;nacos.home&#125;&#x2F;logs&#x2F;cmdb-main.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;2GB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;7GB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;CONSOLE&quot; class&#x3D;&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;naming-server&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;naming-server.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;naming-server.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;7GB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;async-naming-server&quot; class&#x3D;&quot;ch.qos.logback.classic.AsyncAppender&quot;&gt;</span><br><span class="line">                        &lt;discardingThreshold&gt;0&lt;&#x2F;discardingThreshold&gt;</span><br><span class="line">                        &lt;queueSize&gt;1024&lt;&#x2F;queueSize&gt;</span><br><span class="line">                        &lt;neverBlock&gt;true&lt;&#x2F;neverBlock&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;naming-server&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;naming-raft&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;naming-raft.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;naming-raft.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;3GB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;async-naming-raft&quot; class&#x3D;&quot;ch.qos.logback.classic.AsyncAppender&quot;&gt;</span><br><span class="line">                        &lt;discardingThreshold&gt;0&lt;&#x2F;discardingThreshold&gt;</span><br><span class="line">                        &lt;queueSize&gt;1024&lt;&#x2F;queueSize&gt;</span><br><span class="line">                        &lt;neverBlock&gt;true&lt;&#x2F;neverBlock&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;naming-raft&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;naming-distro&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;naming-distro.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;naming-distro.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;3GB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;async-naming-distro&quot; class&#x3D;&quot;ch.qos.logback.classic.AsyncAppender&quot;&gt;</span><br><span class="line">                        &lt;discardingThreshold&gt;0&lt;&#x2F;discardingThreshold&gt;</span><br><span class="line">                        &lt;queueSize&gt;1024&lt;&#x2F;queueSize&gt;</span><br><span class="line">                        &lt;neverBlock&gt;true&lt;&#x2F;neverBlock&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;naming-distro&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;naming-event&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;naming-event.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;naming-event.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;3GB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;async-naming-event&quot; class&#x3D;&quot;ch.qos.logback.classic.AsyncAppender&quot;&gt;</span><br><span class="line">                        &lt;discardingThreshold&gt;0&lt;&#x2F;discardingThreshold&gt;</span><br><span class="line">                        &lt;queueSize&gt;1024&lt;&#x2F;queueSize&gt;</span><br><span class="line">                        &lt;neverBlock&gt;true&lt;&#x2F;neverBlock&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;naming-event&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;naming-push&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;naming-push.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;naming-push.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;3GB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line">                &lt;appender name&#x3D;&quot;naming-rt&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;naming-rt.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;naming-rt.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;3GB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%msg%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;naming-performance&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;naming-performance.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;naming-performance.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;3GB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;!--config module logback config--&gt;</span><br><span class="line">                &lt;appender name&#x3D;&quot;dumpFile&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;config-dump.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;config-dump.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;2GB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;7GB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line">                &lt;appender name&#x3D;&quot;pullFile&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;config-pull.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;config-pull.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;20MB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;128MB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line">                &lt;appender name&#x3D;&quot;fatalFile&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;config-fatal.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;config-fatal.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;20MB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;128MB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line">                &lt;appender name&#x3D;&quot;memoryFile&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;config-memory.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;config-memory.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;20MB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;128MB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line">                &lt;appender name&#x3D;&quot;pullCheckFile&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;config-pull-check.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;config-pull-check.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;3GB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%msg%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;clientLog&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;config-client-request.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;config-client-request.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;2GB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;7GB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date|%msg%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;traceLog&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;config-trace.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;config-trace.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;2GB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;7GB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date|%msg%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;notifyLog&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;config-notify.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;config-notify.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;1GB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;3GB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;startLog&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;config-server.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;config-server.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;50MB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;512MB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;rootFile&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;nacos.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;nacos.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;50MB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;512MB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;appender name&#x3D;&quot;nacos-address&quot;</span><br><span class="line">                                  class&#x3D;&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">                        &lt;file&gt;$&#123;LOG_HOME&#125;&#x2F;nacos-address.log&lt;&#x2F;file&gt;</span><br><span class="line">                        &lt;append&gt;true&lt;&#x2F;append&gt;</span><br><span class="line">                        &lt;rollingPolicy class&#x3D;&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">                                &lt;fileNamePattern&gt;$&#123;LOG_HOME&#125;&#x2F;nacos-address.log.%d&#123;yyyy-MM-dd&#125;.%i&lt;&#x2F;fileNamePattern&gt;</span><br><span class="line">                                &lt;maxFileSize&gt;2GB&lt;&#x2F;maxFileSize&gt;</span><br><span class="line">                                &lt;MaxHistory&gt;7&lt;&#x2F;MaxHistory&gt;</span><br><span class="line">                                &lt;totalSizeCap&gt;7GB&lt;&#x2F;totalSizeCap&gt;</span><br><span class="line">                                &lt;cleanHistoryOnStart&gt;true&lt;&#x2F;cleanHistoryOnStart&gt;</span><br><span class="line">                        &lt;&#x2F;rollingPolicy&gt;</span><br><span class="line">                        &lt;encoder&gt;</span><br><span class="line">                                &lt;Pattern&gt;%date %level %msg%n%n&lt;&#x2F;Pattern&gt;</span><br><span class="line">                                &lt;charset&gt;UTF-8&lt;&#x2F;charset&gt;</span><br><span class="line">                        &lt;&#x2F;encoder&gt;</span><br><span class="line">                &lt;&#x2F;appender&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.address.main&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;nacos-address&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.cmdb.main&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;cmdb-main&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.naming.main&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;async-naming-server&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.naming.raft&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;async-naming-raft&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.naming.distro&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;async-naming-distro&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.naming.event&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;async-naming-event&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.naming.push&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;naming-push&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.naming.rt&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;naming-rt&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.naming.performance&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;naming-performance&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.config.dumpLog&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;dumpFile&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.config.pullLog&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;pullFile&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.config.pullCheckLog&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;pullCheckFile&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.config.fatal&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;fatalFile&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.config.monitorLog&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;memoryFile&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.config.clientLog&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;info&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;clientLog&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.config.notifyLog&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;notifyLog&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.config.traceLog&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;info&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;traceLog&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.config.startLog&quot; additivity&#x3D;&quot;false&quot;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;startLog&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;springProfile name&#x3D;&quot;standalone&quot;&gt;</span><br><span class="line">                        &lt;logger name&#x3D;&quot;org.springframework&quot;&gt;</span><br><span class="line">                                &lt;appender-ref ref&#x3D;&quot;CONSOLE&quot;&#x2F;&gt;</span><br><span class="line">                                &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;&#x2F;logger&gt;</span><br><span class="line"></span><br><span class="line">                        &lt;logger name&#x3D;&quot;org.apache.catalina.startup.DigesterFactory&quot;&gt;</span><br><span class="line">                                &lt;appender-ref ref&#x3D;&quot;CONSOLE&quot;&#x2F;&gt;</span><br><span class="line">                                &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;&#x2F;logger&gt;</span><br><span class="line"></span><br><span class="line">                        &lt;logger name&#x3D;&quot;org.apache.catalina.util.LifecycleBase&quot;&gt;</span><br><span class="line">                                &lt;appender-ref ref&#x3D;&quot;CONSOLE&quot;&#x2F;&gt;</span><br><span class="line">                                &lt;level value&#x3D;&quot;ERROR&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;&#x2F;logger&gt;</span><br><span class="line"></span><br><span class="line">                        &lt;logger name&#x3D;&quot;org.apache.coyote.http11.Http11NioProtocol&quot;&gt;</span><br><span class="line">                                &lt;appender-ref ref&#x3D;&quot;CONSOLE&quot;&#x2F;&gt;</span><br><span class="line">                                &lt;level value&#x3D;&quot;WARN&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;&#x2F;logger&gt;</span><br><span class="line"></span><br><span class="line">                        &lt;logger name&#x3D;&quot;org.apache.tomcat.util.net.NioSelectorPool&quot;&gt;</span><br><span class="line">                                &lt;appender-ref ref&#x3D;&quot;CONSOLE&quot;&#x2F;&gt;</span><br><span class="line">                                &lt;level value&#x3D;&quot;WARN&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;&#x2F;logger&gt;</span><br><span class="line">                &lt;&#x2F;springProfile&gt;</span><br><span class="line"></span><br><span class="line">                &lt;logger name&#x3D;&quot;com.alibaba.nacos.core.listener.StartingSpringApplicationRunListener&quot;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;CONSOLE&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;logger&gt;</span><br><span class="line"></span><br><span class="line">                &lt;root&gt;</span><br><span class="line">                        &lt;level value&#x3D;&quot;INFO&quot;&#x2F;&gt;</span><br><span class="line">                        &lt;appender-ref ref&#x3D;&quot;rootFile&quot;&#x2F;&gt;</span><br><span class="line">                &lt;&#x2F;root&gt;</span><br><span class="line">        &lt;&#x2F;configuration&gt;</span><br></pre></td></tr></table></figure>

<h2 id="deploy"><a href="#deploy" class="headerlink" title="deploy"></a>deploy</h2><ul>
<li><p>namespace：pro</p>
</li>
<li><p>查看集群leader</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -X GET &#39;127.0.0.1:8848&#x2F;nacos&#x2F;v1&#x2F;ns&#x2F;raft&#x2F;leader&#39;</span><br></pre></td></tr></table></figure></li>
<li><p>确保配置存在于指定namespace，而非public</p>
</li>
<li><p>确保服务指定的namespace id正确无误</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: deploy-nacos-cloud-1</span><br><span class="line">  labels:</span><br><span class="line">    name: deploy-nacos-cloud-1</span><br><span class="line">  namespace: pro</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: nacos-cloud-1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nacos-cloud-1</span><br><span class="line">        cloud-name: nacos-cloud</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                  - key: cloud-name</span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                      - nacos-cloud</span><br><span class="line">              topologyKey: kubernetes.io&#x2F;hostname</span><br><span class="line">      containers:</span><br><span class="line">      - name: nacos-cloud-1</span><br><span class="line">        image: nacos-server:1.3.2</span><br><span class="line">        env:</span><br><span class="line">        - name: NACOS_SERVER_IP</span><br><span class="line">          value: 192.168.10.1</span><br><span class="line">        - name: JVM_XMS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: JVM_XMX</span><br><span class="line">          value: 512m</span><br><span class="line">        - name: JVM_XMN</span><br><span class="line">          value: 192m</span><br><span class="line">        - name: JVM_MS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: JVM_MMS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: TZ</span><br><span class="line">          value: Asia&#x2F;Shanghai</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8848</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;nacos&#x2F;</span><br><span class="line">            port: 8848</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 3</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;nacos&#x2F;</span><br><span class="line">            port: 8848</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 3</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &quot;&#x2F;home&#x2F;nacos&#x2F;conf&quot;</span><br><span class="line">          name: nacos-cloud-config</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nacos-cloud-config</span><br><span class="line">          configMap:   </span><br><span class="line">            name: nacos-cloud-config</span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: svc-nacos-cloud-1</span><br><span class="line">  labels:</span><br><span class="line">    name: svc-nacos-cloud-1</span><br><span class="line">  namespace: pro</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 192.168.10.1</span><br><span class="line">  selector:</span><br><span class="line">    name: nacos-cloud-1</span><br><span class="line">  ports:</span><br><span class="line">  - name: port1</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 8848</span><br><span class="line">    targetPort: 8848</span><br><span class="line">---</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: deploy-nacos-cloud-2</span><br><span class="line">  labels:</span><br><span class="line">    name: deploy-nacos-cloud-2</span><br><span class="line">  namespace: pro</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: nacos-cloud-2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nacos-cloud-2</span><br><span class="line">        cloud-name: nacos-cloud</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                  - key: cloud-name</span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                      - nacos-cloud</span><br><span class="line">              topologyKey: kubernetes.io&#x2F;hostname</span><br><span class="line">      containers:</span><br><span class="line">      - name: nacos-cloud-2</span><br><span class="line">        image: nacos-server:1.3.2</span><br><span class="line">        env:</span><br><span class="line">        - name: NACOS_SERVER_IP</span><br><span class="line">          value: 192.168.10.2</span><br><span class="line">        - name: JVM_XMS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: JVM_XMX</span><br><span class="line">          value: 512m</span><br><span class="line">        - name: JVM_XMN</span><br><span class="line">          value: 192m</span><br><span class="line">        - name: JVM_MS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: JVM_MMS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: TZ</span><br><span class="line">          value: Asia&#x2F;Shanghai</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8848</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;nacos&#x2F;</span><br><span class="line">            port: 8848</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 3</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;nacos&#x2F;</span><br><span class="line">            port: 8848</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 3</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &quot;&#x2F;home&#x2F;nacos&#x2F;conf&quot;</span><br><span class="line">          name: nacos-cloud-config</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nacos-cloud-config</span><br><span class="line">          configMap:   </span><br><span class="line">            name: nacos-cloud-config</span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: svc-nacos-cloud-2</span><br><span class="line">  labels:</span><br><span class="line">    name: svc-nacos-cloud-2</span><br><span class="line">  namespace: pro</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 192.168.10.2</span><br><span class="line">  selector:</span><br><span class="line">    name: nacos-cloud-2</span><br><span class="line">  ports:</span><br><span class="line">  - name: port1</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 8848</span><br><span class="line">    targetPort: 8848</span><br><span class="line">---</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: deploy-nacos-cloud-3</span><br><span class="line">  labels:</span><br><span class="line">    name: deploy-nacos-cloud-3</span><br><span class="line">  namespace: pro</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: nacos-cloud-3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: nacos-cloud-3</span><br><span class="line">        cloud-name: nacos-cloud</span><br><span class="line">    spec:</span><br><span class="line">      affinity:        </span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            - labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                  - key: cloud-name</span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                      - nacos-cloud</span><br><span class="line">              topologyKey: kubernetes.io&#x2F;hostname</span><br><span class="line">      containers:</span><br><span class="line">      - name: nacos-cloud-3</span><br><span class="line">        image: nacos-server:1.3.2</span><br><span class="line">        env:</span><br><span class="line">        - name: NACOS_SERVER_IP</span><br><span class="line">          value: 192.168.10.3</span><br><span class="line">        - name: JVM_XMS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: JVM_XMX</span><br><span class="line">          value: 512m</span><br><span class="line">        - name: JVM_XMN</span><br><span class="line">          value: 192m</span><br><span class="line">        - name: JVM_MS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: JVM_MMS</span><br><span class="line">          value: 256m</span><br><span class="line">        - name: TZ</span><br><span class="line">          value: Asia&#x2F;Shanghai</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8848</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;nacos&#x2F;</span><br><span class="line">            port: 8848</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 3</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x2F;nacos&#x2F;</span><br><span class="line">            port: 8848</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 3</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 1</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: &quot;&#x2F;home&#x2F;nacos&#x2F;conf&quot;</span><br><span class="line">          name: nacos-cloud-config</span><br><span class="line">      volumes:</span><br><span class="line">        - name: nacos-cloud-config</span><br><span class="line">          configMap:   </span><br><span class="line">            name: nacos-cloud-config</span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: svc-nacos-cloud-3</span><br><span class="line">  labels:</span><br><span class="line">    name: svc-nacos-cloud-3</span><br><span class="line">  namespace: pro</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 192.168.10.3</span><br><span class="line">  selector:</span><br><span class="line">    name: nacos-cloud-3</span><br><span class="line">  ports:</span><br><span class="line">  - name: port1</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 8848</span><br><span class="line">    targetPort: 8848</span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: nacos-svc</span><br><span class="line">  labels:</span><br><span class="line">    name: nacos-svc</span><br><span class="line">  namespace: pro</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    cloud-name: nacos-cloud</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - name: port1</span><br><span class="line">    protocol: TCP</span><br><span class="line">    port: 8848</span><br><span class="line">    targetPort: 8848</span><br><span class="line">    nodePort: 30848</span><br></pre></td></tr></table></figure>

</li>
</ul>
]]></content>
      <categories>
        <category>k8s</category>
        <category>nacos</category>
      </categories>
      <tags>
        <tag>k8s</tag>
        <tag>nacos</tag>
      </tags>
  </entry>
  <entry>
    <title>nginx反向代理dns缓存问题</title>
    <url>/2020/12/16/nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86dns%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<p>为解决前端跨域问题，使用了nginx反向代理做处理</p>
<a id="more"></a>

<blockquote>
<p>location ^~ /public_static/ {<br>   proxy_pass <a href="https://example.com/">https://example.com</a>;<br>}</p>
</blockquote>
<h1 id="问题简介"><a href="#问题简介" class="headerlink" title="问题简介"></a>问题简介</h1><blockquote>
<p>​        example.com为cdn域名，ip是动态解析的，上线几天后，发现网站资源加载不出来，查看nginx日志发现资源全部超时了。查询nginx相关文档，确认nginx在启动加载配置文件时，会把域名接信息成ip，然后把IP缓存起来，以后会一直使用解析到的IP并且不会再更改，除非重新启动Nginx，Nginx才会重新解析域名。</p>
</blockquote>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><h2 id="第一种-使用nginx的resolver"><a href="#第一种-使用nginx的resolver" class="headerlink" title="第一种 使用nginx的resolver"></a>第一种 使用nginx的resolver</h2><ul>
<li><p>默认nginx会使用/etc/resolv.conf下的域名服务器进行解析</p>
</li>
<li><p>可以通过在nginx配置文件中的http部分或者server部分设定如下配置</p>
<blockquote>
<p>server {</p>
<p>​    resolver 100.100.2.136 100.100.2.138 valid=3000s;</p>
<p>​    resolver_timeout 3s;</p>
<p>}</p>
</blockquote>
</li>
<li><p>resolver 后面指定DNS服务器，可以指定多个，空格隔开</p>
</li>
<li><p>valid设置DNS缓存失效时间</p>
</li>
<li><p>resolver_timeout 指定解析域名时，DNS服务器的超时时间，建议3秒左右</p>
</li>
</ul>
<blockquote>
<p>​        当resolver 后面跟多个DNS服务器时，一定要保证这些DNS服务器都是有效的，因为这种是负载均衡模式的，当DNS记录失效了(超过valid时间)，首先由第一个DNS服务器去解析，下一次继续失效时由第二个DNS服务器去解析，如有任何一个DNS服务器故障，那么这一次的解析会一直持续到resolver_timeout，然后解析失败，且日志报错解析不了域名，通过页面抛出502错误。</p>
</blockquote>
<h2 id="第二种-使用tengine"><a href="#第二种-使用tengine" class="headerlink" title="第二种 使用tengine"></a>第二种 使用tengine</h2><p>版本2.1.2以上，Tengine的ngx_http_upstream_dynamic_module模块，提供了在运行时动态解析upstream中server域名的功能。</p>
<blockquote>
<p>upstream backend {<br>dynamic_resolve fallback=stale fail_timeout=30s;<br>server a.com;<br>server b.com;<br>}</p>
</blockquote>
]]></content>
      <categories>
        <category>centos</category>
        <category>nginx</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>elasticsearch通过logstash同步mysql</title>
    <url>/2021/01/12/elasticsearch%E9%80%9A%E8%BF%87logstash%E5%90%8C%E6%AD%A5mysql/</url>
    <content><![CDATA[<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><ul>
<li>elasticsearch版本：<code>7.4</code></li>
<li>logstash版本：<code>7.4</code></li>
<li>mysql版本：<code>8.0</code><a id="more"></a>

</li>
</ul>
<h1 id="logstash配置文件"><a href="#logstash配置文件" class="headerlink" title="logstash配置文件"></a>logstash配置文件</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  jdbc &#123;</span><br><span class="line">    jdbc_driver_class &#x3D;&gt; &quot;com.mysql.jdbc.Driver&quot;</span><br><span class="line">    jdbc_driver_library &#x3D;&gt; &quot;&#x2F;ssd&#x2F;1&#x2F;share&#x2F;ls-cn-***&#x2F;logstash&#x2F;current&#x2F;config&#x2F;custom&#x2F;mysql-connector-java-8.0.18.jar&quot;</span><br><span class="line">    jdbc_connection_string &#x3D;&gt; &quot;jdbc:mysql:&#x2F;&#x2F;***:3306&#x2F;数据库名?useUnicode&#x3D;true&amp;characterEncoding&#x3D;utf-8&amp;useSSL&#x3D;false&amp;allowLoadLocalInfile&#x3D;false&amp;autoDeserialize&#x3D;false&quot;</span><br><span class="line">    jdbc_user &#x3D;&gt; &quot;&quot;</span><br><span class="line">    jdbc_password &#x3D;&gt; &quot;&quot;</span><br><span class="line">    #sql是否允许分页</span><br><span class="line">    jdbc_paging_enabled &#x3D;&gt; &quot;true&quot;</span><br><span class="line">    jdbc_page_size &#x3D;&gt; &quot;100000&quot;</span><br><span class="line">    #查询sql，通过update_time实现增量更新，order排序确保更新时间为最新时间</span><br><span class="line">    statement &#x3D;&gt; &quot;select &#96;a&#96;.&#96;id&#96; AS &#96;id&#96; where &#96;a&#96;.&#96;update_time&#96;&gt;&#x3D; :sql_last_value order by update_time ASC&quot;</span><br><span class="line">    schedule &#x3D;&gt; &quot; *&#x2F;5 * * * * *&quot;</span><br><span class="line">    record_last_run &#x3D;&gt; true</span><br><span class="line">    last_run_metadata_path &#x3D;&gt; &quot;&#x2F;ssd&#x2F;1&#x2F;ls-cn-zz11yyn8e00a&#x2F;logstash&#x2F;data&#x2F;last_run_metadata_test_resource_company_update_time0107.txt&quot;</span><br><span class="line">    clean_run &#x3D;&gt; false</span><br><span class="line">    #分数字类型和时间戳类型，默认数字，无更新操作可以使用主键做增量更新</span><br><span class="line">    tracking_column_type &#x3D;&gt; &quot;timestamp&quot;</span><br><span class="line">    use_column_value &#x3D;&gt; true</span><br><span class="line">    tracking_column &#x3D;&gt; &quot;update_time&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">#更新es时间存储格式为datetime类型，es创建索引需要增加format支持datetime格式</span><br><span class="line">#      &quot;create_time&quot;: &#123;</span><br><span class="line">#       &quot;type&quot;: &quot;date&quot;,</span><br><span class="line">#       &quot;format&quot;: &quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd&quot;&#125;</span><br><span class="line">  ruby&#123;</span><br><span class="line">      code &#x3D;&gt; &quot;</span><br><span class="line">      event.set(&#39;create_time&#39;, (event.get(&#39;create_time&#39;).time.localtime).strftime(&#39;%Y-%m-%d %H:%M:%S&#39;))</span><br><span class="line">      event.set(&#39;review_time&#39;, (event.get(&#39;review_time&#39;).time.localtime).strftime(&#39;%Y-%m-%d %H:%M:%S&#39;))</span><br><span class="line">      &quot;</span><br><span class="line">      &#125;</span><br><span class="line">  date &#123;    </span><br><span class="line">        match &#x3D;&gt; [&quot;create_time&quot;, &quot;yyyy-MM-dd HH:mm:ss&quot;]   </span><br><span class="line">  &#125;</span><br><span class="line">  date &#123;    </span><br><span class="line">        match &#x3D;&gt; [&quot;review_time&quot;, &quot;yyyy-MM-dd HH:mm:ss&quot;]   </span><br><span class="line">  &#125;</span><br><span class="line">  mutate &#123;</span><br><span class="line">    remove_field &#x3D;&gt; [&quot;@timestamp&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line"> elasticsearch &#123;</span><br><span class="line">    hosts &#x3D;&gt; &quot;http:&#x2F;&#x2F;*****:9200&quot;</span><br><span class="line">    index &#x3D;&gt; &quot;es_index&quot;</span><br><span class="line">    user &#x3D;&gt; &quot;elastic&quot;</span><br><span class="line">    password &#x3D;&gt; &quot;****&quot;</span><br><span class="line">    document_id &#x3D;&gt; &quot;%&#123;id&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="devtools常用接口"><a href="#devtools常用接口" class="headerlink" title="devtools常用接口"></a>devtools常用接口</h1><blockquote>
<p>#修改索引最大查询数</p>
<p>PUT es_index/_settings<br>{<br>  “index”:{<br>    “max_result_window”:1000000<br>  }<br>}</p>
<p>#定义索引别名</p>
<p>POST /_aliases<br>{<br>  “actions”: [<br>    {<br>      “add”: {<br>        “index”: “es_index0114”,<br>        “alias”: “es_index”<br>      }<br>    }<br>  ]<br>}</p>
<p>#es使用sql语法</p>
<p>POST /_sql<br>{<br>  “query”: “select * from es_index where id = ‘26427’”<br>}</p>
</blockquote>
<h1 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h1><ul>
<li>logstash支持mysql视图查询，但数据过多时查询很慢，iops压力会很大，建议使用查询语句查询</li>
<li>logstash支持秒级查询，格式同crontab</li>
<li>mysql默认时间0000-00-00,非有效日期,logstash无法同步</li>
</ul>
]]></content>
      <categories>
        <category>centos</category>
      </categories>
      <tags>
        <tag>es</tag>
      </tags>
  </entry>
  <entry>
    <title>kubernetes--pod的生命周期管理</title>
    <url>/2021/02/03/kubernetes-pod%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<p>Kubernetes 支持 postStart 和 preStop 事件。当一个主容器启动后，Kubernetes 将立即发送 postStart 事件；在主容器被终结之前，Kubernetes 将发送一个 preStop 事件。</p>
<a id="more"></a>

<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>服务更新时时常出现服务繁忙情况，因为后端服务代理在经过nginx之后还有一层网关服务，网关服务无法通过k8s获取到pod的健康状态，而是通过nacos获取的，pod关闭后，nacos健康状态无法及时更新，导致网关服务路由到不健康的pod服务上。</p>
<p>通过lifecycle的preStop可以很方便解决这一问题。</p>
<h2 id="lifecycle"><a href="#lifecycle" class="headerlink" title="lifecycle"></a>lifecycle</h2><p>创建资源对象时，可以使用lifecycle来管理容器在运行前和关闭前的一些动作。</p>
<p>lifecycle有两种回调函数：</p>
<ul>
<li>postStart：容器创建成功后，运行前的任务，用于资源部署、环境准备等。</li>
<li>preStop：在容器被终止前的任务，用于优雅关闭应用程序、通知其他系统等等。</li>
</ul>
<p>通过预停止脚本，当容器关闭前会将服务从nacos下线</p>
<h3 id="shell脚本"><a href="#shell脚本" class="headerlink" title="shell脚本"></a>shell脚本</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -X PUT &quot;nacos地址&#x2F;nacos&#x2F;v1&#x2F;ns&#x2F;instance?serviceName&#x3D;$MY_SERVICE_NAME&amp;ip&#x3D;$MY_POD_IP&amp;port&#x3D;$MY_POD_PORT&amp;enabled&#x3D;false&amp;namespaceId&#x3D;&quot;</span><br></pre></td></tr></table></figure>

<h3 id="yaml文件"><a href="#yaml文件" class="headerlink" title="yaml文件"></a>yaml文件</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">containers:</span><br><span class="line">  - env:</span><br><span class="line">      - name: LANG</span><br><span class="line">        value: en_US.UTF-8</span><br><span class="line">      - name: JAVA_HOME</span><br><span class="line">        value: &#x2F;usr&#x2F;java&#x2F;jdk</span><br><span class="line">      - name: TZ</span><br><span class="line">        value: Asia&#x2F;Shanghai</span><br><span class="line">      - name: MY_SERVICE_NAME</span><br><span class="line">        value: </span><br><span class="line">      - name: MY_POD_PORT</span><br><span class="line">        value: &#39;8080&#39;</span><br><span class="line">      - name: MY_POD_IP</span><br><span class="line">        valueFrom:</span><br><span class="line">          fieldRef:</span><br><span class="line">            fieldPath: status.podIP</span><br><span class="line">    image: &#39;&#39;</span><br><span class="line">    imagePullPolicy: Always</span><br><span class="line">    name: </span><br><span class="line">      lifecycle:</span><br><span class="line">        preStop:</span><br><span class="line">          exec:</span><br><span class="line">            command: [&quot;&#x2F;bin&#x2F;sh&quot;,&quot;&#x2F;pre-stop.sh&quot;]</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>k8s</category>
        <category>pod</category>
      </categories>
      <tags>
        <tag>k8s</tag>
        <tag>pod</tag>
      </tags>
  </entry>
  <entry>
    <title>spring项目从启动到提供访问经过了哪些服务</title>
    <url>/2021/06/03/spring%E9%A1%B9%E7%9B%AE%E4%BB%8E%E5%90%AF%E5%8A%A8%E5%88%B0%E6%8F%90%E4%BE%9B%E8%AE%BF%E9%97%AE%E7%BB%8F%E8%BF%87%E4%BA%86%E5%93%AA%E4%BA%9B%E6%9C%8D%E5%8A%A1/</url>
    <content><![CDATA[<h2 id="1、dns"><a href="#1、dns" class="headerlink" title="1、dns"></a>1、dns</h2><p>当一个用户在地址栏输入一个域名时，DNS解析过程如下：</p>
<a id="more"></a>
<ol>
<li>浏览器先检查自身缓存中有没有被解析过的这个域名对应的ip地址，如果有，解析结束。</li>
<li>如果浏览器缓存没有命中，检查操作系统中本地的hosts文件是否有这个网址映射关系，如果有，就先调用这个IP地址映射，完成域名解析。</li>
<li>如果还没有命中域名，才会真正的请求本地域名服务器（LDNS）来解析这个域名，这台服务器会缓存域名解析结果，大约80%的域名解析到这里就完成了。</li>
<li>如果LDNS仍然没有命中，就直接跳到Root Server 域名服务器迭代查询解析，直到获取到zjyjc.com的dns服务器地址。</li>
<li>当本地DNS服务器收到这个地址后，就会找zjyjc.com域服务器，进行递归查询，直至找到<a href="http://www.zjyjc.com主机./">www.zjyjc.com主机。</a></li>
</ol>
<p><a href="https://imgtu.com/i/21h78S"><img src="https://z3.ax1x.com/2021/06/03/21h78S.png" alt="21h78S.png"></a></p>
<h2 id="2、cdn"><a href="#2、cdn" class="headerlink" title="2、cdn"></a>2、cdn</h2><p>由分布在不同区域的边缘节点服务器群组成的分布式网络。</p>
<p>阿里云DNS调度系统为用户分配cname的最佳节点IP地址：</p>
<ul>
<li>如果该IP地址对应的节点已缓存该资源，则会将数据直接返回给用户。</li>
<li>如果该IP地址对应的节点未缓存该资源，则节点向源站发起对该资源的请求。获取资源后，结合用户自定义配置的缓存策略，将资源缓存至节点。</li>
</ul>
<p><a href="https://imgtu.com/i/214YIP"><img src="https://z3.ax1x.com/2021/06/03/214YIP.png" alt="214YIP.png"></a></p>
<p><a href="https://imgtu.com/i/2140MQ"><img src="https://z3.ax1x.com/2021/06/03/2140MQ.png" alt="2140MQ.png"></a></p>
<h2 id="3、waf-web应用防火墙"><a href="#3、waf-web应用防火墙" class="headerlink" title="3、waf(web应用防火墙)"></a>3、waf(web应用防火墙)</h2><p>通过cname方式接入</p>
<p>​        WAF可以有效识别Web业务流量的恶意特征，在对流量进行清洗和过滤后，将正常、安全的流量返回给服务器，避免网站服务器被恶意入侵导致服务器性能异常等问题，保障网站的业务安全和数据安全。</p>
<p><a href="https://imgtu.com/i/215s6e"><img src="https://z3.ax1x.com/2021/06/03/215s6e.png" alt="215s6e.png"></a></p>
<h2 id="4、slb-负载均衡"><a href="#4、slb-负载均衡" class="headerlink" title="4、slb(负载均衡)"></a>4、slb(负载均衡)</h2><p>​        slb通过监听ingress容器组的80,443端口，提供容器外部可访问的url。</p>
<p><a href="https://imgtu.com/i/21IgvF"><img src="https://z3.ax1x.com/2021/06/03/21IgvF.png" alt="21IgvF.png"></a></p>
<h2 id="5、service"><a href="#5、service" class="headerlink" title="5、service"></a>5、service</h2><p>​        service类型主要有ClusterIP、NodePort、LoadBalancer3种。</p>
<p>​        service以标签的形式选定一组带有指定标签的 Pod，并监控和自动负载他们的 Pod IP，我们只需要通过 Service IP 访问就行了。</p>
<p>​        Pod是Kubernetes创建或部署的最小/最简单的基本单位，一个Pod代表集群上正在运行的一个进程。一个Pod封装一个应用容器（也可以有多个容器）。</p>
<p><a href="https://imgtu.com/i/21H1sS"><img src="https://z3.ax1x.com/2021/06/03/21H1sS.png" alt="21H1sS.png"></a></p>
<p><a href="https://imgtu.com/i/21biYn"><img src="https://z3.ax1x.com/2021/06/03/21biYn.png" alt="21biYn.png"></a></p>
<h2 id="6、nginx"><a href="#6、nginx" class="headerlink" title="6、nginx"></a>6、nginx</h2><blockquote>
<p>server {<br>       listen       80 default_server;<br>       server_name  <a href="http://www.zjyjc.com/">www.zjyjc.com</a>;<br>       location / {<br>         root /zjye/html/home;<br>         index index.html;<br>         try_files $uri $uri/ /index.html;<br>       }<br>       location ^~ /api/admin {<br>         proxy_pass <a href="http://admin-api/">http://admin-api</a>;<br>       }<br>       location ^~ /api/ {<br>         proxy_pass <a href="http://gateway/">http://gateway</a>;<br>       }<br>   }<br>   upstream gateway {<br>   server zjye-gateway-pro;<br>   }<br>   upstream admin-api {<br>   server zjye-admin-api-pro;<br>   }</p>
</blockquote>
<p><a href="https://imgtu.com/i/21LXS1"><img src="https://z3.ax1x.com/2021/06/03/21LXS1.png" alt="21LXS1.png"></a></p>
<p><a href="https://imgtu.com/i/21XZC9"><img src="https://z3.ax1x.com/2021/06/03/21XZC9.png" alt="21XZC9.png"></a></p>
<h2 id="7、gateway"><a href="#7、gateway" class="headerlink" title="7、gateway"></a>7、gateway</h2><p>gateway服务中application.yml定义路由策略</p>
<blockquote>
<p>server:<br>  port: 19340</p>
<p>spring:<br>  cloud:<br>    gateway:<br>      routes:<br>        - id: eauth<br>          order: 10<br>          uri: lb://zjye-sso-api<br>          predicates:<br>            - Path=/api/auth/**</p>
</blockquote>
<p>nacos服务发现<br><a href="https://imgtu.com/i/21Ooct"><img src="https://z3.ax1x.com/2021/06/03/21Ooct.png" alt="21Ooct.png"></a></p>
<h2 id="8、spring项目"><a href="#8、spring项目" class="headerlink" title="8、spring项目"></a>8、spring项目</h2><p>bootstrap.yml定义服务名及启动参数</p>
<blockquote>
<p>spring:<br>  application:<br>    name: zjye-sso-api<br>  profiles:<br>    active: local<br>  cloud:<br>    nacos:<br>      discovery:<br>        server-addr: ${NACOS_SERVER:}:${NACOS_PORT:8848}<br>        namespace: ${NACOS_NAMESPACE:}<br>      config:<br>        server-addr: ${NACOS_SERVER:}:${NACOS_PORT:8848}<br>        namespace: ${NACOS_NAMESPACE:}<br>        file-extension: yml<br>        shared-dataids: application-sso-${spring.profiles.active}.yml<br>        refreshable-dataids: application-sso-${spring.profiles.active}.yml</p>
</blockquote>
<p>gradle clean bootJar生成jar包，构建docker镜像，deployment中为容器设置预启动命令及参数</p>
<p><a href="https://imgtu.com/i/21vAp9"><img src="https://z3.ax1x.com/2021/06/03/21vAp9.png" alt="21vAp9.png"></a></p>
<p>通过3个环境变量在nacos服务中确定配置，完成注册</p>
<p><a href="https://imgtu.com/i/21XzIe"><img src="https://z3.ax1x.com/2021/06/03/21XzIe.png" alt="21XzIe.png"></a></p>
<p>服务yml文件</p>
<blockquote>
<p>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  labels:<br>    app: zjye-sso-api-pro<br>  name: zjye-sso-api-pro<br>  namespace: pro<br>spec:<br>  progressDeadlineSeconds: 600<br>  replicas: 3<br>  selector:<br>    matchLabels:<br>      app: zjye-sso-api-pro<br>  strategy:<br>    rollingUpdate:<br>      maxSurge: 50%<br>      maxUnavailable: 50%<br>    type: RollingUpdate<br>  template:<br>    metadata:<br>      labels:<br>        app: zjye-sso-api-pro<br>    spec:<br>      affinity:<br>        podAntiAffinity:<br>          requiredDuringSchedulingIgnoredDuringExecution:<br>            - labelSelector:<br>                matchExpressions:<br>                  - key: app<br>                    operator: In<br>                    values:<br>                      - zjye-sso-api-pro<br>                    topologyKey: kubernetes.io/hostname<br>                  containers:<br>                - args:<br>                        - ‘-jar’<br>                        - ./zjye-api.jar<br>                        - ‘-XX:+UseG1GC’<br>                        - ‘-XX:+HeapDumpOnOutOfMemoryError’<br>                        - ‘-Xms512M’<br>                        - ‘-Xmx4G’<br>                        - ‘–spring.profiles.active=prod’<br>                        - ‘–NACOS_SERVER=nacos-svc’<br>                        - ‘–NACOS_NAMESPACE=829cc240-d9’<br>                    command:<br>                        - java<br>                    env:<br>                        - name: LANG<br>                        value: en_US.UTF-8<br>                        - name: JAVA_HOME<br>                        value: /usr/java/jdk<br>                        - name: TZ<br>                        value: Asia/Shanghai<br>                        - name: aliyun_logs_zjye-sso-api<br>                        value: /zjye/log/zjye-sso-api/*.log<br>                        - name: MY_SERVICE_NAME<br>                        value: zjye-sso-api<br>                        - name: MY_POD_PORT<br>                        value: ‘19330’<br>                        - name: MY_POD_IP<br>                        valueFrom:<br>                      fieldRef:<br>                        fieldPath: status.podIP<br>                      image: ‘registry-vpc.cn-zhangjiakou.aliyuncs.com/zjye/zjye-sso-api:latest’<br>                      imagePullPolicy: Always<br>                      name: zjye-sso-api-pro<br>                      lifecycle:<br>                          preStop:<br>                        exec:<br>                      command: [“/bin/sh”,”/pre-stop.sh”]<br>                      ports:<br>                        - containerPort: 19330<br>                        protocol: TCP<br>                      livenessProbe:<br>                          failureThreshold: 3<br>                          httpGet:<br>                        path: /doc.html<br>                        port: 19330<br>                        scheme: HTTP<br>                          initialDelaySeconds: 3<br>                          periodSeconds: 10<br>                          successThreshold: 1<br>                          timeoutSeconds: 5<br>                      readinessProbe:<br>                          failureThreshold: 3<br>                          httpGet:<br>                        path: /doc.html<br>                        port: 19330<br>                        scheme: HTTP<br>                          initialDelaySeconds: 3<br>                          periodSeconds: 10<br>                          successThreshold: 2<br>                          timeoutSeconds: 1<br>                      resources:<br>                          limits:<br>                        cpu: ‘4’<br>                        ephemeral-storage: 4Gi<br>                        memory: 6Gi<br>                          requests:<br>                        cpu: 500m<br>                        memory: 1024Mi<br>                        restartPolicy: Always</p>
</blockquote>
]]></content>
      <categories>
        <category>k8s</category>
        <category>spring</category>
      </categories>
      <tags>
        <tag>k8s</tag>
        <tag>spring</tag>
      </tags>
  </entry>
</search>
